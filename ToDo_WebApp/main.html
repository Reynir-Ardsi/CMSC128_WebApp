<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>To-Do List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #d5d4d5;
      display: flex;
      justify-content: center;
      padding: 40px;
    }
    .todo-container, .edit-container {
      background: white;
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.15);
      width: 400px;
    }
    h2 { text-align: center; color: #333; margin-bottom: 15px; }
    .input-row {
      display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px;
    }
    .input-row input, .input-row select {
      padding: 8px; border: 1px solid #ccc; border-radius: 6px;
    }
    #taskInput { flex: 1; }
    button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    button.add-btn { background: #28a745; color: white; }
    button.edit-btn { background: #007bff; color: white; }
    button.delete-btn { background: #dc3545; color: white; }
    button.save-btn { background: #28a745; color: white; width: 100%; margin-top: 10px; }
    button.cancel-btn { background: #dc3545; color: white; width: 100%; margin-top: 8px; }
    ul { list-style: none; padding: 0; margin: 0; }
    ul li {
      padding: 10px; margin-bottom: 8px;
      background: #d5d4d5; border: 1px solid #ddd;
      border-radius: 8px; display: flex; justify-content: space-between;
      align-items: center; gap: 5px;
    }
    .task-text.done { text-decoration: line-through; color: gray; }
    .task-info { flex: 1; }
    .task-time { font-size: 0.8em; color: #666; }
    .priority-tag {
      font-size: 0.75em; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white;
    }
    .high { background: #dc3545; }
    .mid { background: #ffc107; color: #333; }
    .low { background: #28a745; }
    .actions button { margin-left: 4px; }
    .sort-row { margin-bottom: 10px; text-align: right; }
    .form-group { margin-bottom: 12px; }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s;
    }
    .toast button {
      background: transparent;
      border: 1px solid #fff;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    .hidden { display: none; }
  </style>
</head>

<body>
  <!-- ===================== MAIN PAGE ===================== -->
  <div class="todo-container" id="mainPage">
    <h2>To-Do List</h2>

    <div class="input-row">
      <input type="text" id="taskInput" placeholder="Task name" />
      <input type="date" id="dueDate" />
      <input type="time" id="dueTime" />
      <select id="priorityInput">
        <option value="Low">Low</option>
        <option value="Mid">Mid</option>
        <option value="High">High</option>
      </select>
      <button class="add-btn" onclick="addTask()">Add</button>
    </div>

    <div class="sort-row">
      <label for="sortBy">Sort by: </label>
      <select id="sortBy" onchange="renderTasks()">
        <option value="added">Date Added</option>
        <option value="due">Due Date</option>
        <option value="priority">Priority</option>
      </select>
    </div>

    <ul id="taskList"></ul>
  </div>

  <!-- ===================== EDIT PAGE ===================== -->
  <div class="edit-container hidden" id="editPage">
    <h2>Edit Task</h2>
    <div class="form-group">
      <label>Task Name:</label>
      <input type="text" id="editName" />
    </div>
    <div class="form-group">
      <label>Due Date:</label>
      <input type="date" id="editDueDate" />
    </div>
    <div class="form-group">
      <label>Due Time:</label>
      <input type="time" id="editDueTime" />
    </div>
    <div class="form-group">
      <label>Priority:</label>
      <select id="editPriority">
        <option value="Low">Low</option>
        <option value="Mid">Mid</option>
        <option value="High">High</option>
      </select>
    </div>
    <button class="save-btn" onclick="saveTask()">Save</button>
    <button class="cancel-btn" onclick="cancelEdit()">Cancel</button>
  </div>

  <div id="toastContainer"></div>

  <script>
    /**OVERLAY**/
    function openModal(taskId) {
      const modal = document.getElementById("editModal");
      const content = document.getElementById("modalContent");

      fetch(`edit.html?id=${taskId}`)
        .then(response => response.text())
        .then(html => {
          content.innerHTML = html;
          modal.style.display = "block";
        });
    }

    function closeModal() {
      document.getElementById("editModal").style.display = "none";
    }

    /**BACKEND**/
    const API_URL = "http://localhost:5000/tasks";
    let tasks = [];
    const priorityOrder = { High: 1, Mid: 2, Low: 3 };
    let lastDeleted = null;
    let toastTimeout = null;
    let editingTask = null;

    // ===================== FETCH TASKS =====================
    async function fetchTasks() {
      const res = await fetch(API_URL);
      tasks = await res.json();
      renderTasks();
    }

    // ===================== ADD TASK =====================
    async function addTask() {
      const name = document.getElementById("taskInput").value.trim();
      const dueDate = document.getElementById("dueDate").value;
      const dueTime = document.getElementById("dueTime").value;
      const priority = document.getElementById("priorityInput").value;
      if (!name) return alert("Task cannot be empty");

      const newTask = {
        name, dueDate, dueTime, priority, done: false, added: Date.now()
      };

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newTask)
      });
      const savedTask = await res.json();
      tasks.push(savedTask);

      document.getElementById("taskInput").value = "";
      document.getElementById("dueDate").value = "";
      document.getElementById("dueTime").value = "";
      document.getElementById("priorityInput").value = "Low";
      renderTasks();
    }

    // ===================== TOGGLE DONE =====================
    async function toggleDone(index) {
      const task = tasks[index];
      task.done = !task.done;
      await fetch(`${API_URL}/${task._id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(task)
      });
      renderTasks();
    }

    // ===================== DELETE TASK =====================
    async function deleteTask(index) {
      const task = tasks[index];
      if (!confirm(`Delete "${task.name}"?`)) return;
      lastDeleted = { ...task, index };
      await fetch(`${API_URL}/${task._id}`, { method: "DELETE" });
      tasks.splice(index, 1);
      renderTasks();
      showToast("Task deleted");
    }

    async function undoDelete() {
      if (!lastDeleted) return;
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastDeleted)
      });
      const restoredTask = await res.json();
      tasks.splice(lastDeleted.index, 0, restoredTask);
      renderTasks();
      hideToast();
      lastDeleted = null;
    }

    // ===================== EDIT TASK =====================
    function openEdit(index) {
      editingTask = tasks[index];
      document.getElementById("mainPage").classList.add("hidden");
      document.getElementById("editPage").classList.remove("hidden");

      document.getElementById("editName").value = editingTask.name;
      document.getElementById("editDueDate").value = editingTask.dueDate;
      document.getElementById("editDueTime").value = editingTask.dueTime;
      document.getElementById("editPriority").value = editingTask.priority;
    }

    async function saveTask() {
      if (!editingTask) return;
      const updatedTask = {
        name: document.getElementById("editName").value,
        dueDate: document.getElementById("editDueDate").value,
        dueTime: document.getElementById("editDueTime").value,
        priority: document.getElementById("editPriority").value
      };
      await fetch(`${API_URL}/${editingTask._id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedTask)
      });
      cancelEdit();
      fetchTasks();
    }

    function cancelEdit() {
      document.getElementById("editPage").classList.add("hidden");
      document.getElementById("mainPage").classList.remove("hidden");
      editingTask = null;
    }

    // ===================== RENDER TASKS =====================
    function renderTasks() {
      const sortBy = document.getElementById("sortBy").value;
      const list = document.getElementById("taskList");
      list.innerHTML = "";

      if (sortBy === "added") tasks.sort((a, b) => a.added - b.added);
      else if (sortBy === "due") tasks.sort((a, b) => (a.dueDate + a.dueTime).localeCompare(b.dueDate + b.dueTime));
      else if (sortBy === "priority") tasks.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

      tasks.forEach((task, index) => {
        const li = document.createElement("li");
        const info = document.createElement("div");
        info.classList.add("task-info");

        const text = document.createElement("div");
        text.classList.add("task-text");
        if (task.done) text.classList.add("done");
        text.textContent = task.name;

        const priority = document.createElement("span");
        priority.classList.add("priority-tag", task.priority.toLowerCase());
        priority.textContent = task.priority;
        text.appendChild(priority);

        const time = document.createElement("div");
        time.classList.add("task-time");
        time.textContent = `Due: ${task.dueDate || "-"} ${task.dueTime || ""}`;

        info.appendChild(text);
        info.appendChild(time);

        const actions = document.createElement("div");
        actions.classList.add("actions");

        const doneBtn = document.createElement("button");
        doneBtn.textContent = "✔";
        doneBtn.onclick = () => toggleDone(index);

        const editBtn = document.createElement("button");
        editBtn.textContent = "✏";
        editBtn.classList.add("edit-btn");
        editBtn.onclick = () => openEdit(index);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "🗑";
        deleteBtn.classList.add("delete-btn");
        deleteBtn.onclick = () => deleteTask(index);

        actions.appendChild(doneBtn);
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        li.appendChild(info);
        li.appendChild(actions);
        list.appendChild(li);
      });
    }

    // ===================== TOAST =====================
    function showToast(message) {
      const container = document.getElementById("toastContainer");
      container.innerHTML = `
        <div class="toast">
          ${message}
          <button onclick="undoDelete()">Undo</button>
        </div>`;
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(hideToast, 4000);
    }
    function hideToast() {
      document.getElementById("toastContainer").innerHTML = "";
    }

    fetchTasks();
  </script>
</body>
</html>
