<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Account Management</title>
<style>
:root {
    --background: #0B1120;
    --surface: #1e293b;
    --accent: #2563EB;
    --accent-hover: #3B82F6;
    --text-primary: #F1F5F9;
    --text-secondary: #94A3B8;
    --input-bg: #0F172A;
    --border: #334155;
    --shadow: rgba(0, 0, 0, 0.6);
}

/* Base Layout */
body {
    margin: 0;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: "Segoe UI", Arial, sans-serif;
    background: var(--background);
    color: var(--text-primary);
}

/* Shared Container Styles */
.container {
    background: var(--surface);
    border-radius: 12px;
    box-shadow: 0 8px 24px var(--shadow);
    padding: 32px;
    width: 360px;
    transition: all 0.4s ease;
}

/* Titles */
h2 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 24px;
    color: var(--text-primary);
}

/* Forms */
form {
    display: flex;
    flex-direction: column;
}

input, select {
    padding: 12px;
    margin-bottom: 14px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--input-bg);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    transition: 0.2s ease;
}

input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
}

/* Buttons */
button {
    padding: 12px;
    background: var(--accent);
    border: none;
    border-radius: 6px;
    color: var(--text-primary);
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.15s ease;
}

button:hover {
    background: var(--accent-hover);
    transform: translateY(-1px);
}

/* Toggle Links */
.toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 14px;
    font-size: 14px;
}

.toggle a {
    color: var(--accent-hover);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s;
}

.toggle a:hover {
    color: #a9c8ff;
}

/* Forgot Password Overlay */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 900;
    display: none;
}

#forget-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) translateY(15px);
    z-index: 1000;
    width: 360px;
    border-radius: 12px;
    box-shadow: 0 8px 24px var(--shadow);
    padding: 32px;
    background: var(--surface);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
}

#forget-container.active {
    opacity: 1;
    transform: translate(-50%, -50%) translateY(0);
    pointer-events: auto;
}

/* --- NEW: Custom Alert Popup --- */
#alertOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1900; /* Above forget overlay */
    display: none;
}

#alert-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) translateY(15px);
    z-index: 2000; /* Above everything */
    width: 340px;
    border-radius: 12px;
    box-shadow: 0 8px 24px var(--shadow);
    padding: 32px;
    background: var(--surface);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
    text-align: center;
}

#alert-container.active {
    opacity: 1;
    transform: translate(-50%, -50%) translateY(0);
    pointer-events: auto;
}
</style>
</head>
<body>

<div id="login-container" class="container">
    <h2>Login</h2>
    <form id="loginForm">
        <input type="email" id="login-email" placeholder="Email" required />
        <input type="password" id="login-password" placeholder="Password" required />
        <button type="submit">Login</button>
    </form>
    <div class="toggle">
        <a href="#" id="to-register">Register</a>
        <a href="#" id="to-forget">Forgot Password?</a>
    </div>
</div>

<div id="register-container" class="container" style="display:none;">
    <h2>Register</h2>
    <form id="registerForm">
        <input type="text" id="register-name" placeholder="Full Name" required />
        <input type="email" id="register-email" placeholder="Email" required />
        <input type="password" id="register-password" placeholder="Password" required />
        <input type="password" id="register-confirm" placeholder="Confirm Password" required />
        <select id="register-question" required>
            <option value="">Select a Security Question</option>
            <option value="What is your first pet’s name?">What is your first pet’s name?</option>
            <option value="What is the name of your elementary school?">What is the name of your elementary school?</option>
            <option value="What is your favorite color?">What is your favorite color?</option>
            <option value="What city were you born in?">What city were you born in?</option>
        </select>
        <input type="text" id="register-answer" placeholder="Your Answer" required />
        <button type="submit">Sign Up</button>
    </form>
    <div class="toggle" style="justify-content:center;">
        <a href="#" id="to-login">Back to Login</a>
    </div>
</div>

<div class="overlay" id="forgetOverlay"></div>
<div id="forget-container">
    <h2 id="forget-title">Reset Password</h2>
    <form id="forgetForm">
        <input type="email" id="forget-email" placeholder="Enter your email" required />
        <button type="submit">Continue</button>
    </form>
    <div class="toggle" style="justify-content:center;">
        <a href="#" id="close-forget">Back to Login</a>
    </div>
</div>

<div class="overlay" id="alertOverlay"></div>
<div id="alert-container">
    <h2 id="alert-title">Notification</h2>
    <div id="alert-message" style="margin-bottom: 20px; line-height: 1.6; color: var(--text-secondary);"></div>
    <button id="alert-close-btn" style="width: 100%;">OK</button>
</div>
<script>
// References
const loginContainer = document.getElementById("login-container");
const registerContainer = document.getElementById("register-container");
const forgetContainer = document.getElementById("forget-container");
const forgetOverlay = document.getElementById("forgetOverlay");

// --- PAGE SWITCHING ---
document.getElementById("to-register").onclick = e => {
    e.preventDefault();
    loginContainer.style.display = "none";
    registerContainer.style.display = "block";
};

document.getElementById("to-login").onclick = e => {
    e.preventDefault();
    registerContainer.style.display = "none";
    loginContainer.style.display = "block";
};

// --- (Forgot Password is disabled for now) ---
// We need to add new routes to server.js to fix this.
document.getElementById("to-forget").onclick = e => {
    e.preventDefault();
    alert("Forgot Password logic needs to be updated on the server.");
};
document.getElementById("close-forget").onclick = e => {
    e.preventDefault();
};
forgetOverlay.onclick = () => {};


// --- LOGIN (THE MAIN FIX) ---
document.getElementById("loginForm").onsubmit = async e => {
    e.preventDefault();
    const email = document.getElementById("login-email").value.trim().toLowerCase();
    const password = document.getElementById("login-password").value;

    try {
        // 1. Call the NEW /auth/login route
        const res = await fetch("http://localhost:5000/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        
        // 2. Check for the TOKEN
        if (res.ok && data.token) {
            // 3. SAVE THE TOKEN
            localStorage.setItem("token", data.token);
            localStorage.setItem("userId", data.userId); // Still useful for profile page
            
            // 4. Redirect to dashboard
            window.location.href = "todoDashboard.html";
        } else {
            alert("❌ " + (data.error || "Login failed"));
        }
    } catch (err) {
        console.error(err);
        alert("⚠️ Network error");
    }
};

// --- REGISTER (UPDATED) ---
document.getElementById("registerForm").onsubmit = async e => {
    e.preventDefault();
    const name = document.getElementById("register-name").value.trim();
    const email = document.getElementById("register-email").value.trim().toLowerCase();
    const password = document.getElementById("register-password").value;
    const confirm = document.getElementById("register-confirm").value;
    
    // Note: The JWT server doesn't use security questions by default
    // We can add them back, but for now, let's just register.
    // const question = document.getElementById("register-question").value;
    // const answer = document.getElementById("register-answer").value.trim().toLowerCase();

    if (password !== confirm) return alert("❌ Passwords do not match");

    try {
        // 1. Call the NEW /auth/register route
        const res = await fetch("http://localhost:5000/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // 2. Send the new simple payload
            body: JSON.stringify({ name, email, password })
        });
        const data = await res.json();

        if (res.ok) {
            alert("✅ Account registered! Login now.");
            registerContainer.style.display = "none";
            loginContainer.style.display = "block";
            document.getElementById("registerForm").reset();
        } else {
            alert("❌ " + (data.error || "Registration failed"));
        }
    } catch (err) {
        console.error(err);
        alert("⚠️ Network error");
    }
};
</script>
</body>
</html>