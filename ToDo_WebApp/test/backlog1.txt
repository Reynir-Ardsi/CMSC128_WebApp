<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>To-Do Dashboard â€” Collaborative</title>
<style>
    :root{
        --bg:#0B1120; --surface:#0E2236; --panel:#0F172A; --muted:#94A3B8;
        --primary:#2563EB; --primary-2:#3B82F6; --accent:#22C55E; --danger:#EF4444;
        --text:#F1F5F9; --card:#111827; --glass: rgba(255,255,255,0.04);
        --shadow: 0 6px 22px rgba(2,6,23,0.6);
    }

  *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}
    button{cursor:pointer; font-family:inherit}

    .app { display:flex; height:100vh; width:100vw; overflow:hidden; gap:18px; padding:18px; align-items:stretch; }
    .sidebar { width:33%; min-width:280px; background:linear-gradient(180deg,var(--surface), #0b1626); border-radius:12px; padding:18px; display:flex; flex-direction:column; box-shadow:var(--shadow); position:relative; overflow:hidden; }
    .sidebar-inner { display:flex; flex-direction:column; height:100%; overflow:auto; padding-right:8px; }

    .title-row{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px}
    .title-row h1{margin:0; font-size:20px; font-weight:600}
    .profile-btn{background:var(--primary); border:none; color:var(--text); padding:8px 12px; border-radius:8px; font-weight:600}
    .profile-btn:hover{background:var(--primary-2)}

    details{background:transparent; margin-bottom:12px}
    summary{list-style:none; cursor:pointer; display:flex; justify-content:space-between; align-items:center; padding:8px 6px; border-radius:8px}
    summary:hover{background:var(--glass)}
    .groups-list{margin-top:8px; display:flex; flex-direction:column; gap:8px}
    .group-item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; background:var(--panel); border:1px solid rgba(255,255,255,0.02); transition:transform .12s ease, background .12s ease}
    .group-item:hover{transform:translateY(-3px)}
    .group-item.active{outline:2px solid rgba(59,130,246,.12); box-shadow:0 6px 20px rgba(37,99,235,.06)}
    
    .group-left {
        display:flex; 
        align-items:center; 
        gap: 8px; 
        min-width: 0; 
        flex: 1; 
    }
    .group-name {
        font-weight:600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .group-meta {
        font-size:12px; 
        color:var(--muted);
        white-space: nowrap;
        flex-shrink: 0; 
    }

    .count-badge {
        background: rgba(255,255,255,0.08);
        color: var(--muted);
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 600;
        flex-shrink: 0; 
    }

    .group-summary {cursor: pointer;display: flex; justify-content: space-between; align-items: center; padding: 8px 6px; border-radius: 8px; background: transparent; transition: none;}
    .group-summary:hover {background:var(--glass)}

    .group-actions{display:flex; align-items:center; gap:8px; flex-shrink: 0;}
    .btn-icon{background:none; border:none; color:var(--muted); padding:6px; border-radius:6px; transition: color 0.2s;}
    .btn-icon:hover{background:rgba(255,255,255,0.02); color:var(--text)}
    .btn-icon.delete:hover{color: var(--danger);}

    .add-group-wrap{margin-top:auto; display:flex; justify-content:center}
    .add-group-btn{width:100%; background:var(--primary); border:none; padding:10px; border-radius:8px; color:var(--text); font-weight:700}
    .add-group-btn:hover{background:var(--primary-2)}

    .main { width:67%; background:linear-gradient(180deg,var(--panel), #071122); border-radius:12px; padding:22px; display:flex; flex-direction:column; box-shadow:var(--shadow); overflow:hidden; }
    .main-top { display:flex; align-items:center; justify-content:space-between; gap:12px }
    .add-task-btn{background:var(--accent); border:none; color:#ffffff; padding:10px 14px; border-radius:8px; font-weight:700}
    .add-task-btn:hover{filter:brightness(1.05)}

    .task-area{margin-top:12px; overflow:auto; padding-right:10px; display:flex; flex-direction:column; gap:12px}
    .task-card{display:flex; gap:14px; align-items:center; justify-content:space-between; padding:14px; border-radius:10px; background:var(--panel); border:1px solid rgba(255,255,255,0.02); transition:transform .12s ease, box-shadow .12s ease;}
    .task-card:hover{transform:translateY(-4px); box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    .task-left{display:flex; gap:12px; align-items:center; flex:1}
    .check { width:20px; height:20px; border-radius:4px; border:2px solid rgba(255,255,255,0.12); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; background:transparent; transition: all 0.2s;}
    .check.checked{background:linear-gradient(180deg,var(--primary),var(--primary-2)); border-color:transparent; color:white}
    .task-info{display:flex; flex-direction:column; gap:4px; min-width:0}
    .task-name{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; transition: color 0.2s;}
    .task-due{font-size:13px; color:var(--muted)}
    .task-right{display:flex; align-items:center; gap:8px}
    .priority-tag{padding:6px 8px; border-radius:8px; font-weight:700; font-size:12px}
    .priority-high{background:var(--danger); color:white}
    .priority-mid{background:#FBBF24; color:#1E293B}
    .priority-low{background:var(--accent); color:#042014}
    .task-actions{display:flex; gap:6px; align-items:center}
    .task-actions button{background:none; border:none; color:var(--muted); padding:8px; border-radius:6px}
    .task-actions button:hover{background:rgba(255,255,255,0.02); color:var(--text)}
    
    .task-card.done .task-name{ text-decoration:line-through; color:rgba(255,255,255,0.3); }
    .task-card.done .task-due{ color:rgba(255,255,255,0.3); }
    .task-card.done .priority-tag{opacity:0.4; filter: grayscale(0.8);}

    .overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:9999; }
    .overlay.show{display:flex}
    .modal {width:420px; max-width:94%; padding:18px; border-radius:12px; background:linear-gradient(180deg,var(--surface), #0c1b2b); box-shadow:0 10px 30px rgba(2,6,23,0.7); transform:translateY(8px); opacity:0; transition:opacity .18s ease, transform .18s ease; }
    .overlay.show .modal{transform:none; opacity:1}
    .modal h2{margin:0 0 12px 0}
    .field{display:flex; flex-direction:column; gap:4px; margin-bottom:12px}
    .field input, .field select, .field textarea{padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:var(--panel); color:var(--text); font-family: inherit; font-size: 14px;}
    .modal .row{display:flex; gap:8px}
    .modal .row .field{flex:1}
    .modal .actions{display:flex; gap:8px; margin-top:8px}
    .btn-primary{background:var(--primary); color:white; border:none; padding:10px 12px; border-radius:8px; font-weight:700}
    .btn-danger{background:var(--danger); color:white; border:none; padding:10px 12px; border-radius:8px; font-weight:700}
    .btn-ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); padding:10px 12px; border-radius:8px}
    .muted{color:var(--muted); font-size:13px}
    .flex{display:flex}
    .center{align-items:center}
    .gap6{gap:6px}
    .hidden{display:none}

    /* DROPDOWN STYLES */
    .dropdown-wrap { position: relative; }
    .dropdown-menu { 
        position: absolute; 
        top: 110%; 
        right: 0; 
        background: var(--surface); 
        border: 1px solid rgba(255,255,255,0.1); 
        border-radius: 8px; 
        padding: 6px; 
        display: none; 
        flex-direction: column; 
        gap: 2px; 
        box-shadow: 0 10px 20px rgba(0,0,0,0.5); 
        z-index: 100; 
        min-width: 170px;
    }
    .dropdown-menu.show { display: flex; }
    .dropdown-item { 
        padding: 8px 12px; 
        cursor: pointer; 
        border-radius: 6px; 
        font-size: 13px; 
        color: var(--muted); 
    }
    .dropdown-item:hover { background: rgba(255,255,255,0.05); color: var(--text); }
    .dropdown-item.active { color: var(--primary-2); font-weight: 600; background: rgba(59,130,246,0.1); }

    /* COLLAB SPECIFIC STYLES */
    #collabSearchDropdown {
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
    }
    .member-list {
        margin-top: 16px;
        border-top: 1px solid rgba(255,255,255,0.1);
        padding-top: 12px;
        max-height: 200px;
        overflow-y: auto;
    }
    .member-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--panel);
        padding: 8px 10px;
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 13px;
    }
    .member-info { display: flex; flex-direction: column; }
    .member-name { font-weight: 600; }
    .member-email { font-size: 11px; color: var(--muted); }
</style>
</head>
<body>
<div class="app">

<aside class="sidebar" aria-label="Sidebar">
  <div class="sidebar-inner">
    <div class="title-row">
      <h1>To Do</h1>
      <button class="profile-btn" title="Profile">Profile</button>
    </div>

  <div class="group-summary" id="btnAllTasks">
    <div class="flex center gap6">
      <strong>All Tasks</strong>
      <span class="muted" id="all-count">(0)</span>
    </div>
  </div>

  <details open>
    <summary>
      <div class="flex center gap6">
        <strong>Personal</strong>
        <span class="muted" id="personal-count">(0)</span>
      </div>
      <div class="muted">âŒ„</div>
    </summary>
    <div class="groups-list" id="personalGroups"></div>
  </details>

  <details open>
    <summary>
      <div class="flex center gap6">
        <strong>Collaborative</strong>
        <span class="muted" id="collab-count">(0)</span>
      </div>
      <div class="muted">âŒ„</div>
    </summary>
    <div class="groups-list" id="collabGroups"></div>
  </details>

  <div class="add-group-wrap">
    <button class="add-group-btn" id="btnAddGroup">+ Add Task Group</button>
  </div>
</aside>

<main class="main" aria-label="Main content">
  <div class="main-top">
    <div>
      <h2 id="selectedGroupTitle" style="margin:0">All tasks</h2>
      <div class="muted" id="selectedGroupMeta">Showing all tasks</div>
    </div>
    <div class="flex center gap6">
      <div class="dropdown-wrap">
          <button class="btn-ghost" id="btnSort">â‡… Sort</button>
          <div class="dropdown-menu" id="sortMenu">
              <div class="dropdown-item active" data-sort="newest">Date Added (Newest)</div>
              <div class="dropdown-item" data-sort="oldest">Date Added (Oldest)</div>
              <div class="dropdown-item" data-sort="due">Due Date</div>
              <div class="dropdown-item" data-sort="priority">Priority</div>
          </div>
      </div>
      
      <button class="btn-ghost" id="btnClearCompleted" title="Clear completed" style="display: none;">Clear completed</button>
      <button class="add-task-btn" id="btnAddTask">+ Add Task</button>
      <button class="btn-primary" id="btnAddCollaboratorMain" style="display:none;">+ Add Collaborator</button>
    </div>
  </div>

  <section class="task-area" id="taskArea" aria-live="polite"></section>

</main>
</div> <div class="overlay" id="taskOverlay" aria-hidden="true">
  <div class="modal">
    <h2 id="taskModalTitle">Create Task</h2>
    <div class="field">
      <label class="muted">Task name</label>
      <input id="modalTaskName" placeholder="E.g. Prepare slides" />
    </div>
    <div class="row">
      <div class="field"><label class="muted">Due date</label><input id="modalDueDate" type="date"/></div>
      <div class="field"><label class="muted">Due time</label><input id="modalDueTime" type="time"/></div>
    </div>
    <div class="row">
      <div class="field">
        <label class="muted">Priority</label>
        <select id="modalPriority"><option>Low</option><option>Mid</option><option>High</option></select>
      </div>
      <div class="field">
        <label class="muted">Assign group</label>
        <select id="modalGroup"></select>
      </div>
    </div>
    <div class="actions">
      <button class="btn-primary" id="saveTaskBtn">Save</button>
      <button class="btn-ghost" id="cancelTaskBtn">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="groupOverlay" aria-hidden="true">
Â  <div class="modal">
Â  Â  <h2>Create Task Group</h2>
Â  Â  <div class="field">
Â  Â  Â  <label class="muted">Group name</label>
Â  Â  Â  <input id="modalGroupName" placeholder="E.g. Groceries" />
    </div>
    <div class="field">
        <label class="muted">Type</label>
        <select id="modalGroupType"><option value="personal">Personal</option><option value="collab">Collaborative</option></select>
    </div>
    <div class="actions">
        <button class="btn-primary" id="saveGroupBtn">Create</button>
        <button class="btn-ghost" id="cancelGroupBtn">Cancel</button>
        <button class="btn-danger" id="deleteGroupBtn" style="display:none; margin-left: auto;">Delete</button>
    </div>
  </div>
</div>

<div class="overlay" id="collabOverlay" aria-hidden="true">
  <div class="modal" style="width: 400px;">
    <h2>Manage Collaborators</h2>
    <div class="muted" style="margin-bottom:12px">Search users to add to this group</div>
    
    <div class="field dropdown-wrap">
      <input id="collabSearchInput" placeholder="Search by name or email..." autocomplete="off" />
      <div class="dropdown-menu" id="collabSearchDropdown"></div>
    </div>
    <div class="actions">
        <button class="btn-primary" id="addCollabBtn">Add Selected</button>
        <button class="btn-ghost" id="closeCollabBtn">Close</button>
    </div>

    <div class="member-list" id="memberList"></div>
  </div>
</div>

<div class="overlay" id="confirmOverlay" aria-hidden="true">
  <div class="modal">
    <h2 id="confirmTitle">Confirm</h2>
    <div class="muted" id="confirmMessage">Are you sure?</div>
    <div class="actions" style="margin-top:14px">
      <button class="btn-danger" id="confirmYes">Yes</button>
      <button class="btn-ghost" id="confirmNo">No</button>
    </div>
  </div>
</div>

<div class="overlay" id="notificationOverlay" aria-hidden="true">
  <div class="modal" style="text-align: center;">
    <h2 id="notifTitle">Notification</h2>
    <div class="muted" id="notifMessage" style="margin-bottom:20px; line-height:1.5;"></div>
    <div class="actions" style="justify-content: center;">
      <button class="btn-primary" id="notifClose" style="width:100%">OK</button>
    </div>
  </div>
</div>

<script>

// --- CONFIGURATION ---
const API_URL = "http://localhost:5000";

// --- STATE ---
let state = {
    user: null,
    groups: [],
    tasks: [],
    selectedGroupId: "all",
    editingTaskId: null,
    editingGroupId: null,
    sortBy: "newest"
};

// --- DOM ELEMENTS ---
const personalGroupsEl = document.getElementById("personalGroups");
const collabGroupsEl = document.getElementById("collabGroups");
const taskArea = document.querySelector(".task-area");
const selectedGroupTitle = document.getElementById("selectedGroupTitle");
const selectedGroupMeta = document.getElementById("selectedGroupMeta");
const allCountEl = document.getElementById("all-count");
const personalCountEl = document.getElementById("personal-count");
const collabCountEl = document.getElementById("collab-count");
const modalGroupSelect = document.getElementById("modalGroup");
const collabMainBtn = document.getElementById("btnAddCollaboratorMain");
const clearCompletedBtn = document.getElementById("btnClearCompleted");
const sortBtn = document.getElementById("btnSort");
const sortMenu = document.getElementById("sortMenu");

// Collab Elements
const collabOverlay = document.getElementById("collabOverlay");
const collabSearchInput = document.getElementById("collabSearchInput");
const collabSearchDropdown = document.getElementById("collabSearchDropdown");
const memberListEl = document.getElementById("memberList");
const addCollabBtn = document.getElementById("addCollabBtn");

// --- UTILS ---
function showOverlay(id) { document.getElementById(id).classList.add("show"); }
function hideOverlay(id) { document.getElementById(id).classList.remove("show"); }

function showNotification(title, message) {
    document.getElementById("notifTitle").textContent = title;
    document.getElementById("notifMessage").textContent = message;
    showOverlay("notificationOverlay");
}
document.getElementById("notifClose").onclick = () => hideOverlay("notificationOverlay");

let deleteCallback = null;
function showConfirm(title, message, callback) {
    document.getElementById("confirmTitle").textContent = title;
    document.getElementById("confirmMessage").textContent = message;
    deleteCallback = callback;
    showOverlay("confirmOverlay");
}
document.getElementById("confirmYes").addEventListener("click", () => {
    if (deleteCallback) deleteCallback();
    hideOverlay("confirmOverlay");
});
document.getElementById("confirmNo").addEventListener("click", () => hideOverlay("confirmOverlay"));


function getAuthHeaders() {
    const token = localStorage.getItem("token");
    if (!token) {
        window.location.href = "loginRegister.html";
        return null;
    }
    return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };
}

// --- CORE DATA LOADING ---

async function loadUser() {
    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const res = await fetch(`${API_URL}/auth/profile`, { 
            method: 'GET',
            headers: headers 
        });
        
        if (!res.ok) throw new Error("Invalid session");
        
        state.user = await res.json();
        
        const accountHolderEl = document.createElement('div');
        accountHolderEl.classList.add('muted');
        accountHolderEl.textContent = `Welcome, ${state.user.name}`;
        accountHolderEl.style.marginTop = "-8px"; 
        accountHolderEl.style.marginBottom = "14px"; 
        document.querySelector('.title-row').insertAdjacentElement('afterend', accountHolderEl);

        loadData(); 
    } catch (err) {
        console.error("Authentication failed:", err);
        localStorage.removeItem("token");
        localStorage.removeItem("userId");
        window.location.href = "loginRegister.html";
    }
}

async function loadData() {
    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const res = await fetch(`${API_URL}/api/data`, { 
            method: 'GET',
            headers: headers 
        });
        
        if (!res.ok) throw new Error("Failed to fetch data");
        
        const data = await res.json();
        state.groups = data.groups;
        state.tasks = data.tasks; 
        
        renderGroups();
        populateGroupSelect();
        updateTaskCounts();
        renderTasks();

    } catch (err) {
        console.error("Failed to load data:", err);
    }
}


// --- RENDERING & UI UPDATES ---

function updateTaskCounts() {
    const personalGroups = state.groups.filter(g => g.type === 'personal').map(g => g.id);
    const collabGroups = state.groups.filter(g => g.type === 'collab').map(g => g.id);
    let personalTaskCount = 0;
    let collabTaskCount = 0;

    state.tasks.forEach(task => {
        if (!task.group || personalGroups.includes(task.group)) {
            personalTaskCount++;
        } else if (task.group && collabGroups.includes(task.group)) {
            collabTaskCount++;
        }
    });

    allCountEl.textContent = `(${state.tasks.length})`;
    personalCountEl.textContent = `(${personalTaskCount})`;
    collabCountEl.textContent = `(${collabTaskCount})`;
}

function renderGroups() {
    personalGroupsEl.innerHTML = "";
    collabGroupsEl.innerHTML = "";

    const unassignedTasks = state.tasks.filter(t => !t.group);
    const unassignedEl = document.createElement("div");
    unassignedEl.className = "group-item" + (state.selectedGroupId === "unassigned" ? " active" : "");
    unassignedEl.innerHTML = `
        <div class="group-left">
            <span class="group-name">Unassigned</span>
            <span class="count-badge">${unassignedTasks.length}</span>
        </div>
    `;
    unassignedEl.addEventListener("click", () => selectGroup("unassigned"));
    personalGroupsEl.appendChild(unassignedEl);

    const createGroupItem = (g) => {
        const el = document.createElement("div");
        el.className = "group-item" + (state.selectedGroupId === g.id ? " active" : "");
        el.dataset.id = g.id;
        el.addEventListener("click", () => selectGroup(g));

        const left = document.createElement("div");
        left.className = "group-left";
        left.innerHTML = `<span class="group-name">${g.name}</span>`;
        
        const taskCount = state.tasks.filter(t => t.group === g.id).length;
        left.innerHTML += `<span class="count-badge">${taskCount}</span>`;
        
        if (g.type === 'collab' && g.collaborators) {
             const collabCount = g.collaborators.length;
             left.innerHTML += `<span class="group-meta">(${collabCount} ðŸ‘¥)</span>`;
        }

        const actions = document.createElement("div");
        actions.className = "group-actions";
        
        const editBtn = document.createElement("button");
        editBtn.className = "btn-icon";
        editBtn.innerHTML = "ðŸ“";
        editBtn.title = "Edit Group";
        editBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            openGroupModal(g);
        });
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn-icon delete";
        deleteBtn.innerHTML = "ðŸ—‘ï¸";
        deleteBtn.title = "Delete Group";
        deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            confirmDeleteGroup(g.id);
        });

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        el.appendChild(left);
        el.appendChild(actions);
        return el;
    };

    state.groups.forEach(g => {
        const item = createGroupItem(g);
        if (g.type === "personal") personalGroupsEl.appendChild(item);
        else collabGroupsEl.appendChild(item);
    });

    const allTasksEl = document.getElementById("btnAllTasks");
    allTasksEl.classList.toggle("active", state.selectedGroupId === "all");
}

function renderTasks() {
    taskArea.innerHTML = "";
    let filteredTasks = [...state.tasks]; 

    if (state.selectedGroupId === "all") {
    } else if (state.selectedGroupId === "unassigned") {
        filteredTasks = filteredTasks.filter(t => !t.group);
    } else {
        filteredTasks = filteredTasks.filter(t => t.group === state.selectedGroupId);
    }
    
    const priorityMap = { 'High': 3, 'Mid': 2, 'Low': 1 };
    
    filteredTasks.sort((a, b) => {
        if (state.sortBy === 'newest') {
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        } else if (state.sortBy === 'oldest') {
            return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
        } else if (state.sortBy === 'priority') {
            const pA = priorityMap[a.priority] || 0;
            const pB = priorityMap[b.priority] || 0;
            return pB - pA;
        } else if (state.sortBy === 'due') {
            const dateA = (a.date || '9999-99-99') + (a.time || '');
            const dateB = (b.date || '9999-99-99') + (b.time || '');
            return dateA.localeCompare(dateB);
        }
        return 0;
    });

    const hasCompletedTasks = filteredTasks.some(t => t.done);
    clearCompletedBtn.style.display = hasCompletedTasks ? 'inline-block' : 'none';

    if (filteredTasks.length === 0) {
        taskArea.innerHTML = `<div class="muted" style="padding: 10px; text-align: center;">No tasks found.</div>`;
        return;
    }

    filteredTasks.forEach(t => {
        const card = document.createElement("div");
        card.className = "task-card" + (t.done ? " done" : "");
        card.dataset.id = t.id;
        
        const left = document.createElement("div"); left.className = "task-left";
        
        const check = document.createElement("button"); 
        check.className = "check" + (t.done ? " checked" : "");
        check.innerHTML = t.done ? "âœ”" : "";
        check.addEventListener("click", () => toggleTaskDone(t.id, t.done));
        left.appendChild(check);

        const info = document.createElement("div"); info.className = "task-info";
        const name = document.createElement("div"); name.className = "task-name"; name.textContent = t.name;
        const due = document.createElement("div"); due.className = "task-due";
        due.textContent = (t.date || "") + (t.time ? ` @ ${t.time}` : "");
        info.appendChild(name); info.appendChild(due);
        left.appendChild(info);

        const right = document.createElement("div"); right.className = "task-right";
        if (t.priority) {
            const pri = document.createElement("div"); 
            pri.className = `priority-tag priority-${t.priority.toLowerCase()}`; 
            pri.textContent = t.priority; 
            right.appendChild(pri);
        }
        
        const actions = document.createElement("div"); actions.className = "task-actions";
        
        const editBtn = document.createElement("button");
        editBtn.innerHTML = "âœï¸";
        editBtn.title = "Edit Task";
        editBtn.addEventListener("click", () => openTaskModal(t));
        actions.appendChild(editBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = "ðŸ—‘ï¸";
        deleteBtn.title = "Delete Task";
        deleteBtn.addEventListener("click", () => confirmDeleteTask(t.id, t.name));
        actions.appendChild(deleteBtn);

        right.appendChild(actions);
        card.appendChild(left); 
        card.appendChild(right);
        taskArea.appendChild(card);
    });
}

function selectGroup(group) {
    if (group === "unassigned") {
        state.selectedGroupId = "unassigned";
        selectedGroupTitle.textContent = "Unassigned Tasks";
        selectedGroupMeta.textContent = "Tasks without a group";
        collabMainBtn.style.display = 'none';
    } else {
        state.selectedGroupId = group ? group.id : "all";
        selectedGroupTitle.textContent = group ? group.name : "All tasks";
        
        if (group && group.type === 'collab') {
            collabMainBtn.style.display = 'block';
            selectedGroupMeta.textContent = `Collaborative group. ${group.collaborators ? group.collaborators.length : 0} members.`;
        } else {
            collabMainBtn.style.display = 'none';
            selectedGroupMeta.textContent = group ? group.type + ' group.' : 'Showing all tasks';
        }
    }

    renderGroups();
    renderTasks();
}

function populateGroupSelect() {
    modalGroupSelect.innerHTML = '<option value="">(Unassigned)</option>';
    state.groups.forEach(g => {
        const option = document.createElement('option');
        option.value = g.id;
        option.textContent = `${g.name} (${g.type})`;
        modalGroupSelect.appendChild(option);
    });
}

// --- COLLABORATOR LOGIC ---
let selectedUserToAdd = null; 

collabSearchInput.addEventListener("input", async (e) => {
    const q = e.target.value.trim();
    if (q.length < 2) {
        collabSearchDropdown.classList.remove('show');
        return;
    }

    const headers = getAuthHeaders();
    if (!headers) return;
    
    try {
        const res = await fetch(`${API_URL}/api/users/search?q=${q}`, { headers });
        const users = await res.json();
        
        collabSearchDropdown.innerHTML = '';
        if (users.length > 0) {
            collabSearchDropdown.classList.add('show');
            users.forEach(u => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = `${u.name} (${u.email})`;
                item.addEventListener('click', () => {
                    collabSearchInput.value = u.email;
                    selectedUserToAdd = u;
                    collabSearchDropdown.classList.remove('show');
                });
                collabSearchDropdown.appendChild(item);
            });
        } else {
            collabSearchDropdown.classList.remove('show');
        }
    } catch (err) { console.error("Search error", err); }
});

document.getElementById("closeCollabBtn").addEventListener("click", () => hideOverlay("collabOverlay"));

collabMainBtn.addEventListener("click", () => {
    const group = state.groups.find(g => g.id === state.selectedGroupId);
    if (!group) return;
    
    collabSearchInput.value = "";
    selectedUserToAdd = null;
    memberListEl.innerHTML = "";
    
    let ownerId = null;
    let ownerName = "Unknown";
    let ownerEmail = "";

    if (group.owner && typeof group.owner === 'object') {
        ownerId = group.owner._id;
        ownerName = group.owner.name;
        ownerEmail = group.owner.email;
    } else if (group.owner) {
        ownerId = group.owner;
        if (ownerId === state.user._id) {
             ownerName = state.user.name + " (You)";
             ownerEmail = state.user.email;
        } else {
             ownerName = "Owner"; 
        }
    }

    const amIOwner = (state.user._id === ownerId);

    // Render Owner
    const ownerRow = document.createElement("div");
    ownerRow.className = "member-item";
    ownerRow.style.borderLeft = "2px solid var(--primary)";
    ownerRow.innerHTML = `
        <div class="member-info">
            <span class="member-name">${ownerName} <span style="font-size:10px; color:var(--primary); font-weight:bold;">(Owner)</span></span>
            <span class="member-email">${ownerEmail}</span>
        </div>
    `;
    memberListEl.appendChild(ownerRow);
    
    // Render Collaborators
    if (group.collaborators) {
        group.collaborators.forEach(u => {
            const uId = (u && typeof u === 'object') ? u._id : u;
            if (String(uId) === String(ownerId)) return;

            const row = document.createElement("div");
            row.className = "member-item";
            
            const uName = (u && u.name) ? u.name : "Loading...";
            const uEmail = (u && u.email) ? u.email : "";
            const isMe = (String(uId) === String(state.user._id));

            row.innerHTML = `
                <div class="member-info">
                    <span class="member-name">${uName} ${isMe ? '(You)' : ''}</span>
                    <span class="member-email">${uEmail}</span>
                </div>
            `;

            if (amIOwner || isMe) {
                const delBtn = document.createElement("button");
                delBtn.className = "btn-icon delete";
                delBtn.innerHTML = isMe ? "ðŸšª" : "ðŸ—‘ï¸";
                delBtn.title = isMe ? "Leave Group" : "Remove User";
                
                delBtn.addEventListener("click", () => {
                    const msg = isMe ? "Are you sure you want to leave this group?" : "Remove this user from the group?";
                    showConfirm("Confirm Action", msg, () => removeCollaborator(group.id, uId));
                });
                row.appendChild(delBtn);
            }
            
            memberListEl.appendChild(row);
        });
    }
    
    showOverlay("collabOverlay");
});

addCollabBtn.addEventListener("click", async () => {
    const email = collabSearchInput.value.trim();
    if (!email) return showNotification("Input Error", "Please select a user or enter an email.");
    
    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const res = await fetch(`${API_URL}/api/groups/${state.selectedGroupId}/collaborators`, {
            method: 'POST',
            headers,
            body: JSON.stringify({ email })
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to add");
        
        showNotification("Success", "Collaborator added!");
        hideOverlay("collabOverlay");
        await loadData();
    } catch (err) { showNotification("Error", err.message); }
});

async function removeCollaborator(groupId, userId) {
    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const res = await fetch(`${API_URL}/api/groups/${groupId}/collaborators/${userId}`, {
            method: 'DELETE',
            headers
        });
        
        if (!res.ok) throw new Error("Failed to remove");
        
        hideOverlay("collabOverlay");
        await loadData();
    } catch (err) { showNotification("Error", err.message); }
}

// --- MODAL HANDLING ---

function openTaskModal(task = null) {
    state.editingTaskId = task ? task.id : null;
    document.getElementById("taskModalTitle").textContent = task ? "Edit Task" : "Create Task";
    
    document.getElementById("modalTaskName").value = task ? task.name : "";
    document.getElementById("modalDueDate").value = task ? task.date : "";
    document.getElementById("modalDueTime").value = task ? task.time : "";
    document.getElementById("modalPriority").value = task ? task.priority : "Low";
    
    if (task) {
        document.getElementById("modalGroup").value = task.group ? task.group : "";
    } else {
        if (state.selectedGroupId === "all") {
             document.getElementById("modalGroup").value = "";
        } else if (state.selectedGroupId === "unassigned") {
             document.getElementById("modalGroup").value = "";
        } else {
             document.getElementById("modalGroup").value = state.selectedGroupId;
        }
    }
    showOverlay("taskOverlay");
}

function openGroupModal(group = null) {
    state.editingGroupId = group ? group.id : null;
    document.querySelector("#groupOverlay h2").textContent = group ? "Edit Group" : "Create Task Group";
    document.getElementById("saveGroupBtn").textContent = group ? "Save Changes" : "Create";

    document.getElementById("modalGroupName").value = group ? group.name : "";
    document.getElementById("modalGroupType").value = group ? group.type : "personal";
    document.getElementById("deleteGroupBtn").style.display = group ? 'block' : 'none';
    showOverlay("groupOverlay");
}

// --- BACKEND INTERACTIONS ---

async function saveTask() {
    const name = document.getElementById("modalTaskName").value.trim();
    const groupVal = document.getElementById("modalGroup").value;

    if (!name) return showNotification("Validation Error", "Task name required.");

    const data = {
        name,
        date: document.getElementById("modalDueDate").value,
        time: document.getElementById("modalDueTime").value,
        priority: document.getElementById("modalPriority").value,
        groupId: groupVal === "" ? null : groupVal,
    };

    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const method = state.editingTaskId ? "PUT" : "POST";
        const url = state.editingTaskId ? `${API_URL}/api/tasks/${state.editingTaskId}` : `${API_URL}/api/tasks`;

        const res = await fetch(url, { method, headers, body: JSON.stringify(data) });
        if (!res.ok) throw new Error("Server failed");
        
        hideOverlay("taskOverlay");
        await loadData(); 
    } catch (err) { showNotification("Error", "Failed to save task"); }
}

async function saveGroup() {
    const name = document.getElementById("modalGroupName").value.trim();
    const type = document.getElementById("modalGroupType").value;
    if (!name) return showNotification("Validation Error", "Group name required.");
    const data = { name, type };

    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const method = state.editingGroupId ? "PUT" : "POST";
        const url = state.editingGroupId ? `${API_URL}/api/groups/${state.editingGroupId}` : `${API_URL}/api/groups`;
        
        const res = await fetch(url, { method, headers, body: JSON.stringify(data) });
        if (!res.ok) throw new Error("Server failed");
        
        hideOverlay("groupOverlay");
        await loadData();
    } catch (err) { showNotification("Error", "Failed to save group"); }
}

async function toggleTaskDone(taskId, currentDoneState) {
    const task = state.tasks.find(t => t.id === taskId);
    if (task) task.done = !currentDoneState;
    renderTasks(); 

    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        await fetch(`${API_URL}/api/tasks/${taskId}`, {
            method: "PUT",
            headers: headers,
            body: JSON.stringify({ done: !currentDoneState })
        });
    } catch (err) {
        if (task) task.done = currentDoneState;
        renderTasks();
    }
}

async function deleteTask(taskId) {
    const headers = getAuthHeaders();
    if (!headers) return;
    try {
        const res = await fetch(`${API_URL}/api/tasks/${taskId}`, { method: "DELETE", headers });
        if (!res.ok) throw new Error("Failed");
        await loadData();
    } catch (err) { showNotification("Error", "Failed to delete task"); }
}

async function performDeleteGroup(groupId) {
    const headers = getAuthHeaders();
    if (!headers) return;
    try {
        const res = await fetch(`${API_URL}/api/groups/${groupId}`, { method: "DELETE", headers });
        if (!res.ok) throw new Error("Failed");
        hideOverlay("groupOverlay"); 
        if (state.selectedGroupId === groupId) state.selectedGroupId = "all";
        await loadData();
    } catch (err) { showNotification("Error", "Failed to delete group"); }
}

async function clearCompletedTasks() {
    showConfirm("Confirm Action", "Delete all completed tasks?", async () => {
        const headers = getAuthHeaders();
        if (!headers) return;
        try {
            const res = await fetch(`${API_URL}/api/tasks/completed`, { method: "DELETE", headers });
            if (!res.ok) throw new Error("Failed");
            state.tasks = state.tasks.filter(t => !t.done);
            renderTasks();
        } catch (err) { showNotification("Error", "Error clearing tasks"); }
    });
}

// --- EVENT LISTENERS ---
sortBtn.addEventListener('click', (e) => { e.stopPropagation(); sortMenu.classList.toggle('show'); });
document.addEventListener('click', () => { sortMenu.classList.remove('show'); });

document.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', (e) => {
        state.sortBy = e.target.dataset.sort;
        document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));
        e.target.classList.add('active');
        renderTasks(); 
    });
});

document.getElementById("btnAddTask").addEventListener("click", () => openTaskModal());
document.getElementById("cancelTaskBtn").addEventListener("click", () => hideOverlay("taskOverlay"));
document.getElementById("saveTaskBtn").addEventListener("click", saveTask);

document.getElementById("btnAddGroup").addEventListener("click", () => openGroupModal());
document.getElementById("cancelGroupBtn").addEventListener("click", () => hideOverlay("groupOverlay"));
document.getElementById("saveGroupBtn").addEventListener("click", saveGroup);
document.getElementById("deleteGroupBtn").addEventListener("click", () => {
    hideOverlay("groupOverlay");
    confirmDeleteGroup(state.editingGroupId);
});

document.getElementById("btnAllTasks").addEventListener("click", () => selectGroup(null));
document.querySelector(".profile-btn").addEventListener("click", () => { window.location.href = "accountProfile.html"; });
clearCompletedBtn.addEventListener("click", clearCompletedTasks);

function confirmDeleteTask(taskId, taskName) {
    showConfirm("Delete Task", `Delete "${taskName}"?`, () => deleteTask(taskId));
}

function confirmDeleteGroup(groupId) {
    const group = state.groups.find(g => g.id === groupId);
    if (!group) return;
    showConfirm("Delete Group", `Delete "${group.name}"?`, () => performDeleteGroup(groupId));
}

// --- INITIALIZATION ---
loadUser(); 

</script>

</body>
</html>