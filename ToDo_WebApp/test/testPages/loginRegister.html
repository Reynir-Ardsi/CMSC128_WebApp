<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Account Management</title>
<style>
:root {
    --background: #0B1120;
    --surface: #1e293b;
    --accent: #2563EB;
    --accent-hover: #3B82F6;
    --text-primary: #F1F5F9;
    --text-secondary: #94A3B8;
    --input-bg: #0F172A;
    --border: #334155;
    --shadow: rgba(0, 0, 0, 0.6);
}

/* Base Layout */
body {
    margin: 0;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: "Segoe UI", Arial, sans-serif;
    background: var(--background);
    color: var(--text-primary);
}

/* Shared Container Styles */
.container {
    background: var(--surface);
    border-radius: 12px;
    box-shadow: 0 8px 24px var(--shadow);
    padding: 32px;
    width: 360px;
    transition: all 0.4s ease;
}

/* Titles */
h2 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 24px;
    color: var(--text-primary);
}

/* Forms */
form {
    display: flex;
    flex-direction: column;
}

input, select {
    padding: 12px;
    margin-bottom: 14px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--input-bg);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    transition: 0.2s ease;
}

input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
}

/* Buttons */
button {
    padding: 12px;
    background: var(--accent);
    border: none;
    border-radius: 6px;
    color: var(--text-primary);
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.15s ease;
}

button:hover {
    background: var(--accent-hover);
    transform: translateY(-1px);
}

/* Toggle Links */
.toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 14px;
    font-size: 14px;
}

.toggle a {
    color: var(--accent-hover);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s;
}

.toggle a:hover {
    color: #a9c8ff;
}

/* Forgot Password Overlay */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 900;
    display: none;
}

#forget-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) translateY(15px);
    z-index: 1000;
    width: 360px;
    border-radius: 12px;
    box-shadow: 0 8px 24px var(--shadow);
    padding: 32px;
    background: var(--surface);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
}

#forget-container.active {
    opacity: 1;
    transform: translate(-50%, -50%) translateY(0);
    pointer-events: auto;
}

/* --- NEW: Custom Alert Popup --- */
#alertOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1900; /* Above forget overlay */
    display: none;
}

#alert-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) translateY(15px);
    z-index: 2000; /* Above everything */
    width: 340px;
    border-radius: 12px;
    box-shadow: 0 8px 24px var(--shadow);
    padding: 32px;
    background: var(--surface);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
    text-align: center;
}

#alert-container.active {
    opacity: 1;
    transform: translate(-50%, -50%) translateY(0);
    pointer-events: auto;
}
</style>
</head>
<body>

<div id="login-container" class="container">
    <h2>Login</h2>
    <form id="loginForm">
        <input type="email" id="login-email" placeholder="Email" required />
        <input type="password" id="login-password" placeholder="Password" required />
        <button type="submit">Login</button>
    </form>
    <div class="toggle">
        <a href="#" id="to-register">Register</a>
        <a href="#" id="to-forget">Forgot Password?</a>
    </div>
</div>

<div id="register-container" class="container" style="display:none;">
    <h2>Register</h2>
    <form id="registerForm">
        <input type="text" id="register-name" placeholder="Full Name" required />
        <input type="email" id="register-email" placeholder="Email" required />
        <input type="password" id="register-password" placeholder="Password" required />
        <input type="password" id="register-confirm" placeholder="Confirm Password" required />
        <select id="register-question" required>
            <option value="">Select a Security Question</option>
            <option value="What is your first pet’s name?">What is your first pet’s name?</option>
            <option value="What is the name of your elementary school?">What is the name of your elementary school?</option>
            <option value="What is your favorite color?">What is your favorite color?</option>
            <option value="What city were you born in?">What city were you born in?</option>
        </select>
        <input type="text" id="register-answer" placeholder="Your Answer" required />
        <button type="submit">Sign Up</button>
    </form>
    <div class="toggle" style="justify-content:center;">
        <a href="#" id="to-login">Back to Login</a>
    </div>
</div>

<div class="overlay" id="forgetOverlay"></div>
<div id="forget-container">
    <h2 id="forget-title">Reset Password</h2>
    <form id="forgetForm">
        <input type="email" id="forget-email" placeholder="Enter your email" required />
        <button type="submit">Continue</button>
    </form>
    <div class="toggle" style="justify-content:center;">
        <a href="#" id="close-forget">Back to Login</a>
    </div>
</div>

<div class="overlay" id="alertOverlay"></div>
<div id="alert-container">
    <h2 id="alert-title">Notification</h2>
    <div id="alert-message" style="margin-bottom: 20px; line-height: 1.6; color: var(--text-secondary);"></div>
    <button id="alert-close-btn" style="width: 100%;">OK</button>
</div>


<script>
// References
const loginContainer = document.getElementById("login-container");
const registerContainer = document.getElementById("register-container");
const forgetContainer = document.getElementById("forget-container");
const forgetOverlay = document.getElementById("forgetOverlay");
const forgetForm = document.getElementById("forgetForm");
const forgetTitle = document.getElementById("forget-title");

// State
let currentEmail = null;
let securityQuestion = null;

// --- NEW: POPUP MODAL ---
const alertContainer = document.getElementById("alert-container");
const alertOverlay = document.getElementById("alertOverlay");
const alertTitle = document.getElementById("alert-title");
const alertMessage = document.getElementById("alert-message");
const alertCloseBtn = document.getElementById("alert-close-btn");

let onPopupClose = null; // Store callback

/**
 * Shows the custom popup.
 * @param {string} message The message to display.
 * @param {string} type 'info', 'success', or 'error'
 * @param {function} onClose Optional callback function to run when closed.
 */
function showPopup(message, type = 'info', onClose = null) {
    if (type === 'error') {
        alertTitle.innerText = "Error";
        alertMessage.style.color = "#F87171"; // Red-ish
    } else if (type === 'success') {
        alertTitle.innerText = "Success";
        alertMessage.style.color = "#34D399"; // Green-ish
    } else {
        alertTitle.innerText = "Notification";
        alertMessage.style.color = "var(--text-secondary)";
    }

    alertMessage.innerHTML = message;
    onPopupClose = onClose; // Store the callback

    alertOverlay.style.display = "block";
    alertContainer.classList.add("active");
}

function closePopup() {
    alertOverlay.style.display = "none";
    alertContainer.classList.remove("active");
    
    // If a callback exists, run it after closing
    if (onPopupClose) {
        onPopupClose();
        onPopupClose = null; // Clear it after running
    }
}

// Wire up close events for the popup
alertCloseBtn.onclick = closePopup;
alertOverlay.onclick = closePopup;

// --- PAGE SWITCHING ---
document.getElementById("to-register").onclick = e => {
    e.preventDefault();
    loginContainer.style.display = "none";
    registerContainer.style.display = "block";
};

document.getElementById("to-login").onclick = e => {
    e.preventDefault();
    registerContainer.style.display = "none";
    loginContainer.style.display = "block";
};

// Open forgot password overlay
document.getElementById("to-forget").onclick = e => {
    e.preventDefault();
    forgetContainer.classList.add("active");
    forgetOverlay.style.display = "block";
    resetForgotForm();
};

// Close overlay
document.getElementById("close-forget").onclick = e => {
    e.preventDefault();
    forgetContainer.classList.remove("active");
    forgetOverlay.style.display = "none";
};

forgetOverlay.onclick = () => {
    forgetContainer.classList.remove("active");
    forgetOverlay.style.display = "none";
};

// Reset form to email input
function resetForgotForm() {
    forgetTitle.innerText = "Reset Password";
    forgetForm.innerHTML = `
        <input type="email" id="forget-email" placeholder="Enter your email" required />
        <button type="submit">Continue</button>
    `;
    currentEmail = null;
    securityQuestion = null;
    attachForgetFormListener();
}

// Attach submit listener
function attachForgetFormListener() {
    const form = document.getElementById("forgetForm");
    form.onsubmit = async e => {
        e.preventDefault();

        // Step 1: Email stage
        if (!currentEmail) {
            const email = document.getElementById("forget-email").value.trim().toLowerCase();
            if (!email) return showPopup("Please enter your email.", "error");

            try {
                const res = await fetch("http://localhost:5000/accounts/forgot", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (res.ok && data.question) {
                    currentEmail = email;
                    securityQuestion = data.question;
                    showSecurityQuestion();
                } else {
                    showPopup("❌ " + (data.error || "Email not found"), "error");
                }
            } catch (err) {
                console.error(err);
                showPopup("⚠️ Network error", "error");
            }
        }
        // Step 2: Security question stage
        else {
            const answer = document.getElementById("security-answer").value.trim().toLowerCase();
            if (!answer) return showPopup("Please answer the security question.", "error");

            try {
                const res = await fetch("http://localhost:5000/accounts/verify-security", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: currentEmail, answer })
                });
                const data = await res.json();

                if (res.ok && data.success) {
                    // Use callback to redirect only after user clicks "OK"
                    showPopup("✅ Correct! Redirecting to dashboard...", "success", () => {
                        window.location.href = "todoDashboard.html";
                    });
                } else {
                    showPopup("❌ Incorrect answer. Try again.", "error");
                }
            } catch (err) {
                console.error(err);
                showPopup("⚠️ Network error", "error");
            }
        }
    };
}

// Show security question in overlay
function showSecurityQuestion() {
    forgetTitle.innerText = "Security Question";
    forgetForm.innerHTML = `
        <div style="margin-bottom:12px;">${securityQuestion}</div>
        <input type="text" id="security-answer" placeholder="Your Answer" required />
        <button type="submit">Submit</button>
    `;
    attachForgetFormListener();
}

// --- LOGIN ---
document.getElementById("loginForm").onsubmit = async e => {
    e.preventDefault();
    const email = document.getElementById("login-email").value.trim().toLowerCase();
    const password = document.getElementById("login-password").value;

    try {
        const res = await fetch("http://localhost:5000/accounts/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (res.ok && data.userId) {
            localStorage.setItem("userId", data.userId);
            window.location.href = "todoDashboard.html";
        } else {
            showPopup("❌ " + (data.error || "Login failed"), "error");
        }
    } catch (err) {
        console.error(err);
        showPopup("⚠️ Network error", "error");
    }
};

// --- REGISTER ---
document.getElementById("registerForm").onsubmit = async e => {
    e.preventDefault();
    const name = document.getElementById("register-name").value.trim();
    const email = document.getElementById("register-email").value.trim().toLowerCase();
    const password = document.getElementById("register-password").value;
    const confirm = document.getElementById("register-confirm").value;
    const question = document.getElementById("register-question").value;
    const answer = document.getElementById("register-answer").value.trim().toLowerCase();

    if (password !== confirm) return showPopup("❌ Passwords do not match", "error");

    try {
        const res = await fetch("http://localhost:5000/accounts/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, password, question, answer })
        });
        const data = await res.json();

        if (res.ok) {
            // Use callback to switch to login only after user clicks "OK"
            showPopup("✅ Account registered! Login now.", "success", () => {
                registerContainer.style.display = "none";
                loginContainer.style.display = "block";
                document.getElementById("registerForm").reset();
            });
        } else {
            showPopup("❌ " + (data.error || "Registration failed"), "error");
        }
    } catch (err) {
        console.error(err);
        showPopup("⚠️ Network error", "error");
    }
};

// Attach listener for initial forgot password form
attachForgetFormListener();
</script>

</body>
</html>