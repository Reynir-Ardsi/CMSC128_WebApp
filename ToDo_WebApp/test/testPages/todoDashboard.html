<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>To-Do Dashboard ‚Äî Collaborative</title>
<style>
  :root{
    --bg:#0B1120; --surface:#0E2236; --panel:#0F172A; --muted:#94A3B8;
    --primary:#2563EB; --primary-2:#3B82F6; --accent:#22C55E; --danger:#EF4444;
    --text:#F1F5F9; --card:#111827; --glass: rgba(255,255,255,0.04);
    --shadow: 0 6px 22px rgba(2,6,23,0.6);
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}
  button{cursor:pointer; font-family:inherit}

  .app { display:flex; height:100vh; width:100vw; overflow:hidden; gap:18px; padding:18px; align-items:stretch; }
  .sidebar { width:33%; min-width:280px; background:linear-gradient(180deg,var(--surface), #0b1626); border-radius:12px; padding:18px; display:flex; flex-direction:column; box-shadow:var(--shadow); position:relative; overflow:hidden; }
  .sidebar-inner { display:flex; flex-direction:column; height:100%; overflow:auto; padding-right:8px; }

  .title-row{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px}
  .title-row h1{margin:0; font-size:20px; font-weight:600}
  .profile-btn{background:var(--primary); border:none; color:var(--text); padding:8px 12px; border-radius:8px; font-weight:600}
  .profile-btn:hover{background:var(--primary-2)}

  details{background:transparent; margin-bottom:12px}
  summary{list-style:none; cursor:pointer; display:flex; justify-content:space-between; align-items:center; padding:8px 6px; border-radius:8px}
  summary:hover{background:var(--glass)}
  .groups-list{margin-top:8px; display:flex; flex-direction:column; gap:8px}
  .group-item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; background:var(--panel); border:1px solid rgba(255,255,255,0.02); transition:transform .12s ease, background .12s ease}
  .group-item:hover{transform:translateY(-3px)}
  .group-item.active{outline:2px solid rgba(59,130,246,.12); box-shadow:0 6px 20px rgba(37,99,235,.06)}
  .group-left{display:flex; align-items:center; gap:10px}
  .group-name{font-weight:600}
  .group-meta{font-size:12px; color:var(--muted)}
  .group-summary {cursor: pointer;display: flex; justify-content: space-between; align-items: center; padding: 8px 6px; border-radius: 8px; background: transparent; transition: none; margin-bottom: 8px;}
  .group-summary:hover {background:var(--glass)}
  .group-summary.active { outline: 2px solid rgba(59,130,246,.12); box-shadow: 0 6px 20px rgba(37,99,235,.06);}

  .group-actions{display:flex; align-items:center; gap:8px}
  .btn-icon{background:none; border:none; color:var(--muted); padding:6px; border-radius:6px}
  .btn-icon:hover{background:rgba(255,255,255,0.02); color:var(--text)}

  .add-group-wrap{margin-top:auto; display:flex; justify-content:center}
  .add-group-btn{width:100%; background:var(--primary); border:none; padding:10px; border-radius:8px; color:var(--text); font-weight:700}
  .add-group-btn:hover{background:var(--primary-2)}

  .main { width:67%; background:linear-gradient(180deg,var(--panel), #071122); border-radius:12px; padding:22px; display:flex; flex-direction:column; box-shadow:var(--shadow); overflow:hidden; }
  .main-top { display:flex; align-items:center; justify-content:space-between; gap:12px }
  .add-task-btn{background:var(--accent); border:none; color:#ffffff; padding:10px 14px; border-radius:8px; font-weight:700}
  .add-task-btn:hover{filter:brightness(1.05)}

  .task-area{margin-top:12px; overflow:auto; padding-right:10px; display:flex; flex-direction:column; gap:12px}
  .task-card{display:flex; gap:14px; align-items:center; justify-content:space-between; padding:14px; border-radius:10px; background:var(--panel); border:1px solid rgba(255,255,255,0.02); transition:transform .12s ease, box-shadow .12s ease;}
  .task-card:hover{transform:translateY(-4px); box-shadow:0 8px 24px rgba(2,6,23,0.6)}
  .task-left{display:flex; gap:12px; align-items:center; flex:1}
  .check { width:20px; height:20px; border-radius:4px; border:2px solid rgba(255,255,255,0.12); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; background:transparent; }
  .check.checked{background:linear-gradient(180deg,var(--primary),var(--primary-2)); border-color:transparent; color:white}
  .task-info{display:flex; flex-direction:column; gap:4px; min-width:0}
  .task-name{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .task-due{font-size:13px; color:var(--muted)}
  .task-right{display:flex; align-items:center; gap:8px}
  .priority-tag{padding:6px 8px; border-radius:8px; font-weight:700; font-size:12px}
  .priority-high{background:var(--danger); color:white}
  .priority-mid{background:#FBBF24; color:#1E293B}
  .priority-low{background:var(--accent); color:#042014}
  .task-actions{display:flex; gap:6px; align-items:center}
  .task-actions button{background:none; border:none; color:var(--muted); padding:8px; border-radius:6px}
  .task-actions button:hover{background:rgba(255,255,255,0.02); color:var(--text)}
  .task-card.done .task-name{ text-decoration:line-through; color:rgba(255,255,255,0.45) }
  .task-card.done .task-due{ color:rgba(255,255,255,0.37) }
  .task-card.done .priority-tag{opacity:0.6}

  .overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:9999; }
  .overlay.show{display:flex}
  .modal { width:420px; max-width:94%; padding:18px; border-radius:12px; background:linear-gradient(180deg,var(--surface), #0c1b2b); box-shadow:0 10px 30px rgba(2,6,23,0.7); transform:translateY(8px); opacity:0; transition:opacity .18s ease, transform .18s ease; }
  .overlay.show .modal{transform:none; opacity:1}
  .modal h2{margin:0 0 12px 0}
  .field{display:flex; flex-direction:column; gap:8px; margin-bottom:10px}
  .field input, .field select, .field textarea{padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:var(--panel); color:var(--text)}
  .modal .row{display:flex; gap:8px}
  .modal .row .field{flex:1}
  .modal .actions{display:flex; gap:8px; margin-top:8px}
  .btn-primary{background:var(--primary); color:white; border:none; padding:10px 12px; border-radius:8px; font-weight:700}
  .btn-danger{background:var(--danger); color:white; border:none; padding:10px 12px; border-radius:8px; font-weight:700}
  .btn-ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); padding:10px 12px; border-radius:8px}
  .muted{color:var(--muted); font-size:13px}
  .flex{display:flex}
  .center{align-items:center}
  .gap6{gap:6px}
  .hidden{display:none}

  /* --- STYLES ADDED FROM PREVIOUS VERSION --- */

  /* Brighter Task Modal */
  #taskOverlay .modal { background:linear-gradient(180deg, #334155, #293648); }
  #taskOverlay .field input, 
  #taskOverlay .field select {
      background: #475569;
      border-color: #58667a;
      color: var(--text); 
  }

  /* Disabled Button Style */
  button:disabled {
      background: #2a3a50 !important;
      color: #5d6d85 !important;
      cursor: not-allowed;
      transform: none !important;
  }

  /* Sort Select */
  .btn-select {
      padding: 10px 14px;
      -webkit-appearance: none;
      appearance: none;
      background-image: none;
      text-align: left;
      border-radius: 8px;
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(255, 255, 255, 0.03);
      font-family: inherit;
      font-weight: 700;
  }
  .btn-select:hover {
      background: var(--glass);
  }

  /* Toast Notification */
  #toast {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      color: #042014;
      padding: 14px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: bottom 0.4s ease;
      z-index: 10000;
  }
  #toast.show { bottom: 24px; }
  #toast.success { background: var(--accent); color: #042014; }
  #toast.error { background: var(--danger); color: var(--text); }
  #toast.info { background: var(--primary); color: var(--text); }

  #toastBtn {
      background: rgba(0,0,0,0.1);
      border: none;
      color: inherit;
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: 600;
  }
  #toast.error #toastBtn { background: rgba(0,0,0,0.2); }
  #toastBtn:hover { background: rgba(0,0,0,0.2); }
  #toastBtn.hidden { display: none; }

  /* Empty State */
  .empty-state {
      padding: 60px 20px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      opacity: 0.7;
  }
  .empty-state-icon {
      font-size: 48px;
      opacity: 0.5;
      margin-bottom: 12px;
  }
  .empty-state p {
      font-size: 16px;
      color: var(--muted);
      margin: 0;
      line-height: 1.5;
  }
</style>
</head>
<body>
<div class="app">

<aside class="sidebar" aria-label="Sidebar">
  <div class="sidebar-inner">
    <div class="title-row">
      <h1>To Do</h1>
      <button class="profile-btn" title="Profile">Profile</button>
    </div>

  <div class="group-summary" id="btnAllTasks">
    <div class="flex center gap6">
      <strong>All Tasks</strong>
      <span class="muted" id="all-count">(0)</span>
    </div>
  </div>

  <details open>
    <summary>
      <div class="flex center gap6">
        <strong>Personal</strong>
        <span class="muted" id="personal-count">(0)</span>
      </div>
      <div class="muted">‚åÑ</div>
    </summary>
    <div class="groups-list" id="personalGroups"></div>
  </details>

  <details open>
    <summary>
      <div class="flex center gap6">
        <strong>Collaborative</strong>
        <span class="muted" id="collab-count">(0)</span>
      </div>
      <div class="muted">‚åÑ</div>
    </summary>
    <div class="groups-list" id="collabGroups"></div>
  </details>

  <div class="add-group-wrap">
    <button class="add-group-btn" id="btnAddGroup">+ Add Task Group</button>
  </div>
  </div> </aside>

<main class="main" aria-label="Main content">
  <div class="main-top">
    <div>
      <h2 id="selectedGroupTitle" style="margin:0">All tasks</h2>
      <div class="muted" id="selectedGroupMeta">Showing all tasks</div>
    </div>
    <div class="flex center gap6">
      <select id="sortSelect" class="btn-select">
            <option value="default">Sort: Default</option>
            <option value="added">Sort: Date Added</option>
            <option value="due">Sort: Due Date</option>
            <option value="priority">Sort: Priority</option>
      </select>
      <button class="btn-ghost" id="btnClearCompleted" title="Clear completed">Clear completed</button>
      <button class="add-task-btn" id="btnAddTask">+ Add Task</button>
      <button class="btn-primary" id="btnAddCollaboratorMain" style="display:none;">+ Add Collaborator</button>
    </div>
  </div>

  <section class="task-area" id="taskArea" aria-live="polite"></section>

</main>
</div> <div class="overlay" id="taskOverlay" aria-hidden="true">
  <div class="modal">
    <h2 id="taskModalTitle">Create Task</h2>
    <div class="field">
      <label class="muted">Task name</label>
      <input id="modalTaskName" placeholder="E.g. Prepare slides" />
    </div>
    <div class="row">
      <div class="field"><label class="muted">Due date</label><input id="modalDueDate" type="date"/></div>
      <div class="field"><label class="muted">Due time</label><input id="modalDueTime" type="time"/></div>
    </div>
    <div class="row">
      <div class="field">
        <label class="muted">Priority</label>
        <select id="modalPriority"><option>Low</option><option>Mid</option><option>High</option></select>
      </div>
      <div class="field">
        <label class="muted">Assign group</label>
        <select id="modalGroup"></select>
      </div>
    </div>
    <div class="actions">
      <button class="btn-primary" id="saveTaskBtn">Save</button>
      <button class="btn-ghost" id="cancelTaskBtn">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="groupOverlay" aria-hidden="true">
  <div class="modal">
    <h2>Create Task Group</h2>
    <div class="field">
      <label class="muted">Group name</label>
      <input id="modalGroupName" placeholder="E.g. Groceries" />
    </div>
    <div class="field">
      <label class="muted">Type</label>
      <select id="modalGroupType"><option value="personal">Personal</option><option value="collab">Collaborative</option></select>
    </div>
    <div class="actions">
      <button class="btn-primary" id="saveGroupBtn">Create</button>
      <button class="btn-ghost" id="cancelGroupBtn">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="confirmOverlay" aria-hidden="true">
  <div class="modal">
    <h2 id="confirmTitle">Confirm</h2>
    <div class="muted" id="confirmMessage">Are you sure?</div>
    <div class="actions" style="margin-top:14px">
      <button class="btn-danger" id="confirmYes">Yes</button>
      <button class="btn-ghost" id="confirmNo">No</button>
    </div>
  </div>
</div>

<div class="overlay" id="collabOverlay" aria-hidden="true">
    <div class="modal">
    <h2>Add Collaborator</h2>
    <div class="field">
        <label class="muted">Username or Email</label>
        <input id="collabSearchInput" placeholder="Enter username or email"/>
    </div>
    <div class="actions">
        <button class="btn-primary" id="collabAddBtn">Add</button>
        <button class="btn-ghost" id="collabCancelBtn">Cancel</button>
    </div>
    </div>
</div>

<div id="toast">
    <span id="toastMessage">Task deleted.</span>
    <button id="toastBtn">Undo</button>
</div>

<script>
// --- GLOBAL STATE ---
// This state is now temporary and refetched from the server
let groups = [];
let tasks = [];
let selectedGroupId = null;
let lastDeletedTaskId = null; // For Undo
let toastTimeout = null; // For Toast
let currentSort = 'default'; // For Sorting

// --- UTIL ---
// We no longer need saveState() or loadState()
function uid(prefix='id'){ return prefix+'_'+Date.now().toString(36)+Math.floor(Math.random()*1000).toString(36); }

// --- API-DRIVEN RENDER ---
const btnAllTasks = document.getElementById('btnAllTasks');
const allCount = document.getElementById('all-count');
const personalGroupsEl = document.getElementById('personalGroups');
const collabGroupsEl = document.getElementById('collabGroups');
const personalCount = document.getElementById('personal-count');
const collabCount = document.getElementById('collab-count');
const selectedGroupTitle = document.getElementById('selectedGroupTitle');
const selectedGroupMeta = document.getElementById('selectedGroupMeta');
const taskArea = document.getElementById('taskArea');
const modalGroupSelect = document.getElementById('modalGroup');

// --- NEW: Main data fetcher ---
async function fetchAndRenderAll() {
  try {
    const res = await fetch('http://localhost:5000/api/data', {
      method: 'GET',
      credentials: 'include' // This sends our auth cookie
    });

    if (res.status === 401) {
      // Not logged in
      window.location.href = 'login.html';
      return;
    }
    
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || 'Failed to fetch data');
    }

    groups = data.groups;
    tasks = data.tasks;
    
    renderGroups();
    renderTasks();

  } catch (err) {
    console.error(err);
    // If auth fails, redirect to login
    if (err.message.includes('401')) {
      window.location.href = 'login.html';
    } else {
      showToast(err.message, 'error');
    }
  }
}

function renderGroups(){
  personalGroupsEl.innerHTML=''; collabGroupsEl.innerHTML='';
  
  btnAllTasks.classList.toggle('active', selectedGroupId === null);
  // We use the global 'tasks' array for the total count
  allCount.textContent = `(${tasks.length})`; 

  const personal = groups.filter(g=>g.type==='personal');
  const collab = groups.filter(g=>g.type==='collab');
  personalCount.textContent=`(${personal.length})`;
  collabCount.textContent=`(${collab.length})`;

  const createGroupEl = (g)=>{
      const item=document.createElement('div'); 
      item.className='group-item'+(selectedGroupId===g.id?' active':''); 
      item.dataset.id=g.id;
      
      const left=document.createElement('div'); left.className='group-left';
      const icon=document.createElement('div'); icon.textContent='üìÅ';
      const name=document.createElement('div'); name.className='group-name'; name.textContent=g.name;
      left.appendChild(icon); left.appendChild(name);

      const actions=document.createElement('div'); actions.className='group-actions';
      const count=document.createElement('div'); count.className='muted'; count.textContent=countTasksForGroup(g.id);
      
      if (g.type === 'collab') {
          const collabBtn = document.createElement('button');
          collabBtn.className = 'btn-icon';
          collabBtn.title = 'Add collaborator';
          collabBtn.innerHTML = '+üë§';
          collabBtn.addEventListener('click', e => {
              e.stopPropagation();
              openCollabModal(g.id);
          });
          actions.appendChild(collabBtn);
      }

      const delBtn=document.createElement('button'); delBtn.className='btn-icon'; delBtn.title='Delete group'; delBtn.innerHTML='‚úñ';
      delBtn.addEventListener('click', e => { 
        e.stopPropagation(); 
        confirmAction(`Delete group "${g.name}"? Tasks remain ungrouped.`, () => deleteGroup(g.id)); 
      });
      actions.appendChild(count); actions.appendChild(delBtn);

      item.appendChild(left); item.appendChild(actions);
      item.addEventListener('click', ()=> selectGroup(g.id));
      return item;
  };
  personal.forEach(g=>personalGroupsEl.appendChild(createGroupEl(g)));
  collab.forEach(g=>collabGroupsEl.appendChild(createGroupEl(g)));
}

// Uses global 'tasks' array
function countTasksForGroup(groupId){ return tasks.filter(t=>t.group===groupId).length; }

// --- Sorting Helper Functions (No change) ---
function priorityToValue(p) { return {'High': 3, 'Mid': 2, 'Low': 1}[p] || 0; }
function sortTasks(a, b) {
    if (a.done !== b.done) return a.done ? 1 : -1;
    switch (currentSort) {
        case 'added': return (a.createdAt || 0) - (b.createdAt || 0);
        case 'due':
            const ta = (a.date || '') + ' ' + (a.time || ''); const tb = (b.date || '') + ' ' + (b.time || '');
            if (ta.trim() && !tb.trim()) return -1; if (!ta.trim() && tb.trim()) return 1;
            if (!ta.trim() && !tb.trim()) { return (a.createdAt || 0) - (b.createdAt || 0); }
            return ta > tb ? 1 : (ta < tb ? -1 : 0);
        case 'priority':
            const pa = priorityToValue(a.priority); const pb = priorityToValue(b.priority);
            if (pa !== pb) return pb - pa;
            return (a.createdAt || 0) - (b.createdAt || 0);
        default:
            const ta_def = (a.date || '') + ' ' + (a.time || ''); const tb_def = (b.date || '') + ' ' + (b.time || '');
            if (ta_def.trim() && !tb_def.trim()) return -1; if (!ta_def.trim() && tb_def.trim()) return 1;
            if (ta_def.trim() && tb_def.trim()) { if (ta_def > tb_def) return 1; if (ta_def < tb_def) return -1; }
            return (a.createdAt || 0) - (b.createdAt || 0);
    }
}

function renderTasks(){
  taskArea.innerHTML='';
  // Use global state
  const filtered = selectedGroupId ? tasks.filter(t => t.group === selectedGroupId) : tasks;
  const sorted = filtered.slice().sort(sortTasks);

  const g = groups.find(x => x.id === selectedGroupId);
  if(selectedGroupId){
      selectedGroupTitle.textContent = g ? g.name : 'Group';
      selectedGroupMeta.textContent = `${sorted.length} task${sorted.length!==1?'s':''}`;
  } else {
      selectedGroupTitle.textContent = 'All tasks';
      selectedGroupMeta.textContent = `${sorted.length} task${sorted.length!==1?'s':''}`;
  }

  if (sorted.length === 0) {
      let icon = 'üéâ';
      let message = "You're all caught up!";
      if (selectedGroupId && g) {
          icon = 'üìÅ';
          message = `No tasks in "${g.name}".<br>Click '+ Add Task' to create one.`;
      } else if (!selectedGroupId && tasks.length > 0) {
          icon = 'üéâ';
          message = `All tasks are in other groups.<br>Select a group or add a new task.`;
      } else if (tasks.length === 0) {
          icon = '‚ú®';
          message = `Welcome! Add a task to get started.`;
      }
      taskArea.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${icon}</div><p>${message}</p></div>`;
      return;
  }

  sorted.forEach(t=>{
      const card=document.createElement('div'); card.className='task-card'+(t.done?' done':'');
      const left=document.createElement('div'); left.className='task-left';
      
      // --- MODIFIED: check listener is now async ---
      const check=document.createElement('div'); check.className='check'+(t.done?' checked':'');
      check.addEventListener('click', async () => {
        try {
          // Send a *partial* update
          const res = await fetch(`http://localhost:5000/api/tasks/${t.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ done: !t.done })
          });
          if (!res.ok) throw new Error('Failed to update task');
          await fetchAndRenderAll(); // Refetch all
        } catch (err) {
          showToast(err.message, 'error');
        }
      });
      left.appendChild(check);
      
      const info=document.createElement('div'); info.className='task-info';
      const name=document.createElement('div'); name.className='task-name'; name.textContent=t.name;
      const due=document.createElement('div'); due.className='task-due'; due.textContent=(t.date||'')+(t.time?' '+t.time:'');
      info.appendChild(name); info.appendChild(due);
      left.appendChild(info);
      const right=document.createElement('div'); right.className='task-right';
      if(t.priority){
          const pri=document.createElement('div'); pri.className='priority-tag priority-'+t.priority.toLowerCase(); pri.textContent=t.priority;
          right.appendChild(pri);
      }
      const actions=document.createElement('div'); actions.className='task-actions';
      const editBtn=document.createElement('button'); editBtn.innerHTML='‚úé'; editBtn.title='Edit task'; 
      editBtn.addEventListener('click', ()=> openTaskModal(t.id)); // 'id' is MongoDB _id
      
      const delBtn=document.createElement('button'); delBtn.innerHTML='‚úñ'; delBtn.title='Delete task'; 
      delBtn.addEventListener('click', ()=> deleteTask(t.id)); // 'id' is MongoDB _id
      
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      right.appendChild(actions);
      card.appendChild(left); card.appendChild(right);
      taskArea.appendChild(card);
      });
}

function selectGroup(groupId){
    // This logic handles clicking a group, or clicking "All Tasks" (null)
    if (groupId === null) {
      selectedGroupId = null;
    } else {
      selectedGroupId = (groupId === selectedGroupId) ? null : groupId;
    }
    // No saveState, just re-render
    renderGroups();
    renderTasks();
}

// --- MODIFIED: CRUD FUNCTIONS ---

async function addGroup(name, type) {
  try {
    const res = await fetch('http://localhost:5000/api/groups', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ name, type })
    });
    if (!res.ok) throw new Error('Failed to create group');
    await fetchAndRenderAll(); // Refetch
  } catch (err) {
    showToast(err.message, 'error');
  }
}

async function deleteGroup(groupId){
  try {
    const res = await fetch(`http://localhost:5000/api/groups/${groupId}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    if (!res.ok) throw new Error('Failed to delete group');
    if (selectedGroupId === groupId) selectedGroupId = null; // Clear selection
    await fetchAndRenderAll(); // Refetch
  } catch (err) {
    showToast(err.message, 'error');
  }
}

// addTask is now handled by saveTaskBtn

async function deleteTask(taskId){
  lastDeletedTaskId = taskId; // Save just the ID for undo
  try {
    const res = await fetch(`http://localhost:5000/api/tasks/${taskId}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    if (!res.ok) throw new Error('Failed to delete task');
    await fetchAndRenderAll(); // Refetch
    showToast('Task deleted', 'error', 5000, true); // Show undo toast
  } catch (err) {
    lastDeletedTaskId = null; // Clear if delete failed
    showToast(err.message, 'error');
  }
}

// --- TOAST NOTIFICATION SYSTEM ---
const toastEl = document.getElementById('toast');
const toastMessage = document.getElementById('toastMessage');
const toastBtn = document.getElementById('toastBtn');

function showToast(message, type = 'info', duration = 3000, showUndo = false) {
    toastMessage.textContent = message;
    toastEl.className = '';
    toastEl.classList.add(type);
    
    if (showUndo && lastDeletedTaskId) {
        toastBtn.classList.remove('hidden');
        toastBtn.onclick = undoDelete;
    } else {
        toastBtn.classList.add('hidden');
    }

    toastEl.classList.add('show');
    if (toastTimeout) clearTimeout(toastTimeout);
    
    if (duration > 0) {
        toastTimeout = setTimeout(() => {
            toastEl.classList.remove('show');
            if (showUndo) {
                lastDeletedTaskId = null; // Clear undo ID after timeout
            }
        }, duration);
    }
}

async function undoDelete() {
    if (lastDeletedTaskId) {
      try {
        const res = await fetch(`http://localhost:5000/api/tasks/${lastDeletedTaskId}/undo`, {
          method: 'POST',
          credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed to undo');
        
        lastDeletedTaskId = null; // Clear ID
        toastEl.classList.remove('show'); // Hide toast
        if (toastTimeout) clearTimeout(toastTimeout);
        
        await fetchAndRenderAll(); // Refetch
        showToast('Task restored', 'info', 2000);

      } catch (err) {
         showToast(err.message, 'error');
      }
    }
}


// --- MODALS ---
function showOverlay(el){ el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
function hideOverlay(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

const taskOverlay=document.getElementById('taskOverlay');
const groupOverlay=document.getElementById('groupOverlay');
const modalTaskName=document.getElementById('modalTaskName');
const modalDueDate=document.getElementById('modalDueDate');
const modalDueTime=document.getElementById('modalDueTime');
const modalPriority=document.getElementById('modalPriority');
const modalGroup=document.getElementById('modalGroup');
const saveTaskBtn=document.getElementById('saveTaskBtn');
const cancelTaskBtn=document.getElementById('cancelTaskBtn');

document.getElementById('btnAddTask').addEventListener('click', ()=> openTaskModal());
cancelTaskBtn.addEventListener('click', ()=> hideOverlay(taskOverlay));

function openTaskModal(taskId=null){
    editingTaskId=taskId;
    modalTaskName.value=''; modalDueDate.value=''; modalDueTime.value=''; modalPriority.value='Low';
    
    // Populate group dropdown
    modalGroup.innerHTML='<option value="">None</option>';
    groups.forEach(g=>{ const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; modalGroup.appendChild(opt); });
    
    if(taskId){
        // Find task from global state
        const t = tasks.find(x => x.id === taskId);
        if(t){ 
          modalTaskName.value=t.name; 
          modalDueDate.value=t.date||''; 
          modalDueTime.value=t.time||''; 
          modalPriority.value=t.priority||'Low'; 
          modalGroup.value = t.group || ''; // t.group is the ID
        }
        saveTaskBtn.disabled = false;
    } else {
        if (selectedGroupId) {
          modalGroup.value = selectedGroupId;
        }
        saveTaskBtn.disabled = true;
    }
    showOverlay(taskOverlay);
}

// Validation
modalTaskName.addEventListener('input', () => {
    saveTaskBtn.disabled = modalTaskName.value.trim().length === 0;
});

// --- MODIFIED: saveTaskBtn listener ---
saveTaskBtn.addEventListener('click', async ()=>{
    const name=modalTaskName.value.trim();
    if(!name) return showToast('Task name is required', 'error');
    
    const taskData = {
      name: name,
      date: modalDueDate.value,
      time: modalDueTime.value,
      priority: modalPriority.value,
      groupId: modalGroup.value || null
    };

    try {
      let url = 'http://localhost:5000/api/tasks';
      let method = 'POST';
      
      if (editingTaskId) {
        url = `http://localhost:5000/api/tasks/${editingTaskId}`;
        method = 'PUT';
      }

      const res = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(taskData)
      });
      
      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Failed to save task');
      }

      hideOverlay(taskOverlay);
      await fetchAndRenderAll(); // Refetch
      showToast(editingTaskId ? 'Task updated' : 'Task added', 'success');

    } catch (err) {
      showToast(err.message, 'error');
    }
});

// --- GROUP MODAL ---
const saveGroupBtn = document.getElementById('saveGroupBtn');
const modalGroupName = document.getElementById('modalGroupName');

document.getElementById('btnAddGroup').addEventListener('click', ()=> {
    modalGroupName.value = '';
    saveGroupBtn.disabled = true;
    showOverlay(groupOverlay);
});
document.getElementById('cancelGroupBtn').addEventListener('click', ()=> hideOverlay(groupOverlay));

modalGroupName.addEventListener('input', () => {
    saveGroupBtn.disabled = modalGroupName.value.trim().length === 0;
});

saveGroupBtn.addEventListener('click', ()=>{
    const name=modalGroupName.value.trim();
    const type=document.getElementById('modalGroupType').value;
    if(!name) return showToast('Group name is required', 'error');
    
    addGroup(name,type); // This is now async
    hideOverlay(groupOverlay);
    showToast('Group created', 'success');
});

// --- COLLABORATOR MODAL ---
const collabOverlay = document.getElementById('collabOverlay');
const collabAddBtn = document.getElementById('collabAddBtn');
const collabSearchInput = document.getElementById('collabSearchInput');
let currentGroupIdForCollab = null;

function openCollabModal(groupId) {
    currentGroupIdForCollab = groupId;
    collabSearchInput.value = '';
    collabAddBtn.disabled = true;
    showOverlay(collabOverlay);
}

collabSearchInput.addEventListener('input', () => {
    collabAddBtn.disabled = collabSearchInput.value.trim().length === 0;
});

document.getElementById('collabCancelBtn').addEventListener('click', ()=> hideOverlay(collabOverlay));

collabAddBtn.addEventListener('click', async ()=>{
    const email = collabSearchInput.value.trim().toLowerCase();
    if(!email) return showToast('Username or email is required', 'error');
    
    try {
      const res = await fetch(`http://localhost:5000/api/groups/${currentGroupIdForCollab}/collaborators`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      
      if (!res.ok) throw new Error(data.error);
      
      showToast(`Added "${email}" to group`, 'success');
      hideOverlay(collabOverlay);
      await fetchAndRenderAll(); // Refetch
      
    } catch (err) {
      showToast(err.message, 'error');
    }
});

// --- CONFIRM (for Groups) ---
const confirmOverlay=document.getElementById('confirmOverlay');
const confirmTitle=document.getElementById('confirmTitle');
const confirmMessage=document.getElementById('confirmMessage');
const confirmYes=document.getElementById('confirmYes');
const confirmNo=document.getElementById('confirmNo');

function confirmAction(message, callback){
    pendingConfirm=callback; 
    confirmTitle.textContent='Confirm'; 
    confirmMessage.textContent=message;
    showOverlay(confirmOverlay);
}
confirmYes.addEventListener('click', ()=> { if(pendingConfirm) pendingConfirm(); pendingConfirm=null; hideOverlay(confirmOverlay); });
confirmNo.addEventListener('click', ()=> { pendingConfirm=null; hideOverlay(confirmOverlay); });

// --- SORT LISTENER ---
const sortSelect = document.getElementById('sortSelect');
sortSelect.addEventListener('change', (e) => {
    currentSort = e.target.value;
    renderTasks();
});

// --- CLEAR COMPLETED ---
document.getElementById('btnClearCompleted').addEventListener('click', async () => {
  try {
    const res = await fetch('http://localhost:5000/api/tasks/completed', {
      method: 'DELETE',
      credentials: 'include'
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    
    await fetchAndRenderAll(); // Refetch
    showToast(data.message, 'info');

  } catch (err) {
    showToast(err.message, 'error');
  }
});

// --- Profile Button ---
document.querySelector('.profile-btn').addEventListener('click', () => {
  window.location.href = 'profile.html';
});

// --- INIT ---
// Fetch all data when the page loads
window.onload = fetchAndRenderAll;

// Add listener for "All Tasks"
btnAllTasks.addEventListener('click', () => selectGroup(null));

</script>
</body>
</html>