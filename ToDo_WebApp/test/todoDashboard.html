<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>To-Do Dashboard â€” Collaborative</title>
<style>
    :root{
        --bg:#0B1120; --surface:#0E2236; --panel:#0F172A; --muted:#94A3B8;
        --primary:#2563EB; --primary-2:#3B82F6; --accent:#22C55E; --danger:#EF4444;
        --text:#F1F5F9; --card:#111827; --glass: rgba(255,255,255,0.04);
        --shadow: 0 6px 22px rgba(2,6,23,0.6);
    }

  *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}
    button{cursor:pointer; font-family:inherit}

    .app { display:flex; height:100vh; width:100vw; overflow:hidden; gap:18px; padding:18px; align-items:stretch; }
    .sidebar { width:33%; min-width:280px; background:linear-gradient(180deg,var(--surface), #0b1626); border-radius:12px; padding:18px; display:flex; flex-direction:column; box-shadow:var(--shadow); position:relative; overflow:hidden; }
    .sidebar-inner { display:flex; flex-direction:column; height:100%; overflow:auto; padding-right:8px; }

    .title-row{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px}
    .title-row h1{margin:0; font-size:20px; font-weight:600}
    .profile-btn{background:var(--primary); border:none; color:var(--text); padding:8px 12px; border-radius:8px; font-weight:600}
    .profile-btn:hover{background:var(--primary-2)}

    details{background:transparent; margin-bottom:12px}
    summary{list-style:none; cursor:pointer; display:flex; justify-content:space-between; align-items:center; padding:8px 6px; border-radius:8px}
    summary:hover{background:var(--glass)}
    .groups-list{margin-top:8px; display:flex; flex-direction:column; gap:8px}
    .group-item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; background:var(--panel); border:1px solid rgba(255,255,255,0.02); transition:transform .12s ease, background .12s ease}
    .group-item:hover{transform:translateY(-3px)}
    .group-item.active{outline:2px solid rgba(59,130,246,.12); box-shadow:0 6px 20px rgba(37,99,235,.06)}
    .group-left{display:flex; align-items:center; gap:10px}
    .group-name{font-weight:600}
    .group-meta{font-size:12px; color:var(--muted)}
    .group-summary {cursor: pointer;display: flex; justify-content: space-between; align-items: center; padding: 8px 6px; border-radius: 8px; background: transparent; transition: none;}
    .group-summary:hover {background:var(--glass)}
    .group-summary.active { outline: 2px solid rgba(59,130,246,.12); box-shadow: 0 6px 20px rgba(37,99,235,.06);}

    .group-actions{display:flex; align-items:center; gap:8px}
    .btn-icon{background:none; border:none; color:var(--muted); padding:6px; border-radius:6px}
    .btn-icon:hover{background:rgba(255,255,255,0.02); color:var(--text)}

    .add-group-wrap{margin-top:auto; display:flex; justify-content:center}
    .add-group-btn{width:100%; background:var(--primary); border:none; padding:10px; border-radius:8px; color:var(--text); font-weight:700}
    .add-group-btn:hover{background:var(--primary-2)}

    .main { width:67%; background:linear-gradient(180deg,var(--panel), #071122); border-radius:12px; padding:22px; display:flex; flex-direction:column; box-shadow:var(--shadow); overflow:hidden; }
    .main-top { display:flex; align-items:center; justify-content:space-between; gap:12px }
    .add-task-btn{background:var(--accent); border:none; color:#ffffff; padding:10px 14px; border-radius:8px; font-weight:700}
    .add-task-btn:hover{filter:brightness(1.05)}

    .task-area{margin-top:12px; overflow:auto; padding-right:10px; display:flex; flex-direction:column; gap:12px}
    .task-card{display:flex; gap:14px; align-items:center; justify-content:space-between; padding:14px; border-radius:10px; background:var(--panel); border:1px solid rgba(255,255,255,0.02); transition:transform .12s ease, box-shadow .12s ease;}
    .task-card:hover{transform:translateY(-4px); box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    .task-left{display:flex; gap:12px; align-items:center; flex:1}
    .check { width:20px; height:20px; border-radius:4px; border:2px solid rgba(255,255,255,0.12); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; background:transparent; }
    .check.checked{background:linear-gradient(180deg,var(--primary),var(--primary-2)); border-color:transparent; color:white}
    .task-info{display:flex; flex-direction:column; gap:4px; min-width:0}
    .task-name{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .task-due{font-size:13px; color:var(--muted)}
    .task-right{display:flex; align-items:center; gap:8px}
    .priority-tag{padding:6px 8px; border-radius:8px; font-weight:700; font-size:12px}
    .priority-high{background:var(--danger); color:white}
    .priority-mid{background:#FBBF24; color:#1E293B}
    .priority-low{background:var(--accent); color:#042014}
    .task-actions{display:flex; gap:6px; align-items:center}
    .task-actions button{background:none; border:none; color:var(--muted); padding:8px; border-radius:6px}
    .task-actions button:hover{background:rgba(255,255,255,0.02); color:var(--text)}
    .task-card.done .task-name{ text-decoration:line-through; color:rgba(255,255,255,0.45) }
    .task-card.done .task-due{ color:rgba(255,255,255,0.37) }
    .task-card.done .priority-tag{opacity:0.6}

    .overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:9999; }
    .overlay.show{display:flex}
    .modal {width:420px; max-width:94%; padding:18px; border-radius:12px; background:linear-gradient(180deg,var(--surface), #0c1b2b); box-shadow:0 10px 30px rgba(2,6,23,0.7); transform:translateY(8px); opacity:0; transition:opacity .18s ease, transform .18s ease; }
    .overlay.show .modal{transform:none; opacity:1}
    .modal h2{margin:0 0 12px 0}
    .field{display:flex; flex-direction:column; gap:4px; margin-bottom:12px}
    .field input, .field select, .field textarea{padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:var(--panel); color:var(--text); font-family: inherit; font-size: 14px;}
    .modal .row{display:flex; gap:8px}
    .modal .row .field{flex:1}
    .modal .actions{display:flex; gap:8px; margin-top:8px}
    .btn-primary{background:var(--primary); color:white; border:none; padding:10px 12px; border-radius:8px; font-weight:700}
    .btn-danger{background:var(--danger); color:white; border:none; padding:10px 12px; border-radius:8px; font-weight:700}
    .btn-ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); padding:10px 12px; border-radius:8px}
    .muted{color:var(--muted); font-size:13px}
    .flex{display:flex}
    .center{align-items:center}
    .gap6{gap:6px}
    .hidden{display:none}
</style>
</head>
<body>
<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar" aria-label="Sidebar">
  <div class="sidebar-inner">
    <div class="title-row">
      <h1>To Do</h1>
      <button class="profile-btn" title="Profile">Profile</button>
    </div>

  <!-- ALL TASKS -->
  <div class="group-summary" id="btnAllTasks">
    <div class="flex center gap6">
      <strong>All Tasks</strong>
      <span class="muted" id="all-count">(0)</span>
    </div>
  </div>

  <!-- PERSONAL -->
  <details open>
    <summary>
      <div class="flex center gap6">
        <strong>Personal</strong>
        <span class="muted" id="personal-count">(0)</span>
      </div>
      <div class="muted">âŒ„</div>
    </summary>
    <div class="groups-list" id="personalGroups"></div>
  </details>

  <!-- COLLABORATIVE -->
  <details open>
    <summary>
      <div class="flex center gap6">
        <strong>Collaborative</strong>
        <span class="muted" id="collab-count">(0)</span>
      </div>
      <div class="muted">âŒ„</div>
    </summary>
    <div class="groups-list" id="collabGroups"></div>
  </details>

  <div class="add-group-wrap">
    <button class="add-group-btn" id="btnAddGroup">+ Add Task Group</button>
  </div>
</aside>

<!-- MAIN -->
<main class="main" aria-label="Main content">
  <div class="main-top">
    <div>
      <h2 id="selectedGroupTitle" style="margin:0">All tasks</h2>
      <div class="muted" id="selectedGroupMeta">Showing all tasks</div>
    </div>
    <div class="flex center gap6">
      <button class="btn-ghost" id="btnClearCompleted" title="Clear completed">Clear completed</button>
      <button class="add-task-btn" id="btnAddTask">+ Add Task</button>
      <button class="btn-primary" id="btnAddCollaboratorMain" style="display:none;">+ Add Collaborator</button>
    </div>
  </div>

<!-- Task Modal -->
<div class="overlay" id="taskOverlay" aria-hidden="true">
  <div class="modal">
    <h2 id="taskModalTitle">Create Task</h2>
    <div class="field">
      <label class="muted">Task name</label>
      <input id="modalTaskName" placeholder="E.g. Prepare slides" />
    </div>
    <div class="row">
      <div class="field"><label class="muted">Due date</label><input id="modalDueDate" type="date"/></div>
      <div class="field"><label class="muted">Due time</label><input id="modalDueTime" type="time"/></div>
    </div>
    <div class="row">
      <div class="field">
        <label class="muted">Priority</label>
        <select id="modalPriority"><option>Low</option><option>Mid</option><option>High</option></select>
      </div>
      <div class="field">
        <label class="muted">Assign group</label>
        <select id="modalGroup"></select>
      </div>
    </div>
    <div class="actions">
      <button class="btn-primary" id="saveTaskBtn">Save</button>
      <button class="btn-ghost" id="cancelTaskBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Group Modal -->
<div class="overlay" id="groupOverlay" aria-hidden="true">
Â  <div class="modal">
Â  Â  <h2>Create Task Group</h2>
Â  Â  <div class="field">
Â  Â  Â  <label class="muted">Group name</label>
Â  Â  Â  <input id="modalGroupName" placeholder="E.g. Groceries" />
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  <label class="muted">Type</label>
Â  Â  Â  <select id="modalGroupType"><option value="personal">Personal</option><option value="collab">Collaborative</option></select>
Â  Â  </div>
Â  Â  <div class="actions">
Â  Â  Â  <button class="btn-primary" id="saveGroupBtn">Create</button>
Â  Â  Â  <button class="btn-ghost" id="cancelGroupBtn">Cancel</button>
Â  Â  Â  Â  Â    <button class="btn-danger" id="deleteGroupBtn" style="display:none; margin-left: auto;">Delete</button>
Â  Â  </div>
Â  </div>
</div>

<!-- Confirm delete overlay -->
<div class="overlay" id="confirmOverlay" aria-hidden="true">
  <div class="modal">
    <h2 id="confirmTitle">Confirm</h2>
    <div class="muted" id="confirmMessage">Are you sure?</div>
    <div class="actions" style="margin-top:14px">
      <button class="btn-danger" id="confirmYes">Yes</button>
      <button class="btn-ghost" id="confirmNo">No</button>
    </div>
  </div>
</div>

<script>

// --- CONFIGURATION ---
const API_URL = "http://localhost:5000";

// --- STATE ---
let state = {
Â  Â  user: null,
Â  Â  groups: [],
Â  Â  tasks: [],
Â  Â  selectedGroupId: "all",
Â  Â  editingTaskId: null,
Â  Â  editingGroupId: null,
};

// --- DOM ELEMENTS ---
const personalGroupsEl = document.getElementById("personalGroups");
const collabGroupsEl = document.getElementById("collabGroups");
const taskArea = document.querySelector(".task-area");
const selectedGroupTitle = document.getElementById("selectedGroupTitle");
const selectedGroupMeta = document.getElementById("selectedGroupMeta");
const allCountEl = document.getElementById("all-count");
const personalCountEl = document.getElementById("personal-count");
const collabCountEl = document.getElementById("collab-count");
const modalGroupSelect = document.getElementById("modalGroup");
const collabMainBtn = document.getElementById("btnAddCollaboratorMain");
const clearCompletedBtn = document.getElementById("btnClearCompleted");

// --- UTILS ---
function showOverlay(id) { document.getElementById(id).classList.add("show"); }
function hideOverlay(id) { document.getElementById(id).classList.remove("show"); }

/**
 * Gets the JWT token and creates auth headers.
 * Redirects to login if token is missing.
 */
function getAuthHeaders() {
    const token = localStorage.getItem("token");
    if (!token) {
        window.location.href = "loginRegister.html"; // Redirect to login
        return null; // Stop execution
    }
    return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };
}

// --- CORE DATA LOADING ---

/**
 * 1. Load User from token.
 * 2. Redirect if not authenticated.
 * 3. Start data fetching (Groups and Tasks).
 */
async function loadUser() {
    const headers = getAuthHeaders();
    if (!headers) return; // Redirected

    try {
        // Fetch profile to verify token and get user info
        const res = await fetch(`${API_URL}/auth/profile`, { 
            method: 'GET',
            headers: headers 
        });
        
        if (!res.ok) throw new Error("Invalid session");
        
        state.user = await res.json();
        
        // Display user name
        // Display user name
const accountHolderEl = document.createElement('div');
accountHolderEl.classList.add('muted');
accountHolderEl.textContent = `Welcome, ${state.user.name}`;

// Add styling for spacing
accountHolderEl.style.marginTop = "-8px"; // Pulls it closer to the title
accountHolderEl.style.marginBottom = "14px"; // Adds space below it

// Insert it *after* the title row, not inside it
document.querySelector('.title-row').insertAdjacentElement('afterend', accountHolderEl);

        loadData(); // Load all groups and tasks
    } catch (err) {
        console.error("Authentication failed:", err);
        localStorage.removeItem("token"); // Clear bad token
        localStorage.removeItem("userId");
        window.location.href = "loginRegister.html";
    }
}

/**
 * Fetches all groups and tasks in one go from the /api/data route.
 */
async function loadData() {
    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const res = await fetch(`${API_URL}/api/data`, { 
            method: 'GET',
            headers: headers 
        });
        
        if (!res.ok) throw new Error("Failed to fetch data");
        
        const data = await res.json();
        // The JWT server sends 'id' not '_id'
        state.groups = data.groups;
        state.tasks = data.tasks;
        
        // Now render everything
        renderGroups();
        populateGroupSelect();
        updateTaskCounts();
        renderTasks();

    } catch (err) {
        console.error("Failed to load data:", err);
        if (err.message.includes("401") || err.message.includes("403")) {
            localStorage.removeItem("token");
            window.location.href = "loginRegister.html";
        }
    }
}


// --- RENDERING & UI UPDATES ---

function updateTaskCounts() {
    const personalGroups = state.groups.filter(g => g.type === 'personal').map(g => g.id);
    const collabGroups = state.groups.filter(g => g.type === 'collab').map(g => g.id);

    let personalTaskCount = 0;
    let collabTaskCount = 0;

    state.tasks.forEach(task => {
        // The JWT server sends 'task.group' as a simple ID
        if (!task.group || personalGroups.includes(task.group)) {
            personalTaskCount++;
        } else if (collabGroups.includes(task.group)) {
            collabTaskCount++;
        }
    });

    allCountEl.textContent = `(${state.tasks.length})`;
    personalCountEl.textContent = `(${personalTaskCount})`;
    collabCountEl.textContent = `(${collabTaskCount})`;
}

function renderGroups() {
    personalGroupsEl.innerHTML = "";
    collabGroupsEl.innerHTML = "";

    const createGroupItem = (g) => {
        const el = document.createElement("div");
        // Use 'g.id' from JWT server
        el.className = "group-item" + (state.selectedGroupId === g.id ? " active" : "");
        el.dataset.id = g.id;
        el.addEventListener("click", () => selectGroup(g));

        const left = document.createElement("div");
        left.className = "group-left";
        left.innerHTML = `<span class="group-name">${g.name}</span>`;
        
        if (g.type === 'collab' && g.collaborators) {
             const collabCount = g.collaborators.length;
             left.innerHTML += `<span class="group-meta">(${collabCount} people)</span>`;
        }

        const actions = document.createElement("div");
        actions.className = "group-actions";
        
        const editBtn = document.createElement("button");
        editBtn.className = "btn-icon";
        editBtn.innerHTML = "ðŸ“";
        editBtn.title = "Edit Group";
        editBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            openGroupModal(g);
        });
        actions.appendChild(editBtn);

        el.appendChild(left);
        el.appendChild(actions);

        return el;
    };

    state.groups.forEach(g => {
        const item = createGroupItem(g);
        if (g.type === "personal") personalGroupsEl.appendChild(item);
        else collabGroupsEl.appendChild(item);
    });

    const allTasksEl = document.getElementById("btnAllTasks");
    allTasksEl.classList.toggle("active", state.selectedGroupId === "all");
}

function renderTasks() {
    taskArea.innerHTML = "";
    
    let filteredTasks = state.tasks;

    if (state.selectedGroupId !== "all") {
        // Use 't.group'
        filteredTasks = state.tasks.filter(t => t.group === state.selectedGroupId);
    }
    
    const hasCompletedTasks = filteredTasks.some(t => t.done);
    clearCompletedBtn.style.display = hasCompletedTasks ? 'inline-block' : 'none';

    if (filteredTasks.length === 0) {
        taskArea.innerHTML = `<div class="muted" style="padding: 10px; text-align: center;">No tasks found for this group.</div>`;
        return;
    }

    filteredTasks.forEach(t => {
        const card = document.createElement("div");
        card.className = "task-card" + (t.done ? " done" : "");
        card.dataset.id = t.id;
        
        const left = document.createElement("div"); left.className = "task-left";
        
        const check = document.createElement("button"); 
        check.className = "check" + (t.done ? " checked" : "");
        check.innerHTML = t.done ? "âœ”" : "";
        // Use 't.id'
        check.addEventListener("click", () => toggleTaskDone(t.id, t.done));
        left.appendChild(check);

        const info = document.createElement("div"); info.className = "task-info";
        const name = document.createElement("div"); name.className = "task-name"; name.textContent = t.name;
        const due = document.createElement("div"); due.className = "task-due";
        // Use 't.date' and 't.time' from JWT server
        due.textContent = (t.date || "") + (t.time ? ` @ ${t.time}` : "");
        info.appendChild(name); info.appendChild(due);
        left.appendChild(info);

        const right = document.createElement("div"); right.className = "task-right";
        
        if (t.priority) {
            const pri = document.createElement("div"); 
            pri.className = `priority-tag priority-${t.priority.toLowerCase()}`; 
            pri.textContent = t.priority; 
            right.appendChild(pri);
        }
        
        const actions = document.createElement("div"); actions.className = "task-actions";
        
        const editBtn = document.createElement("button");
        editBtn.innerHTML = "âœï¸";
        editBtn.title = "Edit Task";
        editBtn.addEventListener("click", () => openTaskModal(t));
        actions.appendChild(editBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = "ðŸ—‘ï¸";
        deleteBtn.title = "Delete Task";
        // Use 't.id'
        deleteBtn.addEventListener("click", () => confirmDeleteTask(t.id, t.name));
        actions.appendChild(deleteBtn);

        right.appendChild(actions);
        card.appendChild(left); 
        card.appendChild(right);
        taskArea.appendChild(card);
    });
}

function selectGroup(group) {
    // Use 'group.id'
    state.selectedGroupId = group ? group.id : "all";
    
    selectedGroupTitle.textContent = group ? group.name : "All tasks";
    
    if (group && group.type === 'collab') {
        collabMainBtn.style.display = 'block';
        selectedGroupMeta.textContent = `Collaborative group. ${group.collaborators ? group.collaborators.length : 0} members.`;
    } else {
        collabMainBtn.style.display = 'none';
        selectedGroupMeta.textContent = group ? group.type + ' group.' : 'Showing all tasks';
    }

    renderGroups();
    renderTasks();
}

function populateGroupSelect() {
    modalGroupSelect.innerHTML = '<option value="">(Personal Task)</option>';
    state.groups.forEach(g => {
        const option = document.createElement('option');
        // Use 'g.id'
        option.value = g.id;
        option.textContent = `${g.name} (${g.type})`;
        modalGroupSelect.appendChild(option);
    });
}

// --- MODAL HANDLING ---

function openTaskModal(task = null) {
    // Use 'task.id'
    state.editingTaskId = task ? task.id : null;
    document.getElementById("taskModalTitle").textContent = task ? "Edit Task" : "Create Task";
    
    document.getElementById("modalTaskName").value = task ? task.name : "";
    // Use 'task.date' and 'task.time'
    document.getElementById("modalDueDate").value = task ? task.date : "";
    document.getElementById("modalDueTime").value = task ? task.time : "";
    document.getElementById("modalPriority").value = task ? task.priority : "Low";
    
    if (task) {
        // Use 'task.group'
        document.getElementById("modalGroup").value = task.group ? task.group : "";
    } else {
        // Pre-select current group when creating
        document.getElementById("modalGroup").value = state.selectedGroupId === "all" ? "" : state.selectedGroupId;
    }
    
    showOverlay("taskOverlay");
}

function openGroupModal(group = null) {
    // Use 'group.id'
    state.editingGroupId = group ? group.id : null;
    document.querySelector("#groupOverlay h2").textContent = group ? "Edit Group" : "Create Task Group";
    document.getElementById("saveGroupBtn").textContent = group ? "Save Changes" : "Create";

    document.getElementById("modalGroupName").value = group ? group.name : "";
    document.getElementById("modalGroupType").value = group ? group.type : "personal";
    
    const deleteBtn = document.getElementById("deleteGroupBtn");
    deleteBtn.style.display = group ? 'block' : 'none';
    
    showOverlay("groupOverlay");
}

// --- BACKEND INTERACTIONS ---

async function saveTask() {
    const name = document.getElementById("modalTaskName").value.trim();
    if (!name) return alert("Task name required.");

    // Send 'date' and 'time'
    const data = {
        name,
        date: document.getElementById("modalDueDate").value,
        time: document.getElementById("modalDueTime").value,
        priority: document.getElementById("modalPriority").value,
        groupId: document.getElementById("modalGroup").value || null,
        // 'owner' is added by the server from the token
    };

    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const method = state.editingTaskId ? "PUT" : "POST";
        // Use '/api' routes
        const url = state.editingTaskId ? `${API_URL}/api/tasks/${state.editingTaskId}` : `${API_URL}/api/tasks`;

        await fetch(url, {
            method,
            headers: headers, // Send token
            body: JSON.stringify(data)
        });

        hideOverlay("taskOverlay");
        await loadData(); // Refresh all data
    } catch (err) {
        console.error("Failed to save task:", err);
        alert("Failed to save task.");
    }
}

async function saveGroup() {
    const name = document.getElementById("modalGroupName").value.trim();
    const type = document.getElementById("modalGroupType").value;
    if (!name) return alert("Group name required.");

    // 'ownerId' is added by the server from the token
    const data = { name, type };

    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const method = state.editingGroupId ? "PUT" : "POST";
        // Use '/api' routes
        const url = state.editingGroupId ? `${API_URL}/api/groups/${state.editingGroupId}` : `${API_URL}/api/groups`;
        
        await fetch(url, {
            method,
            headers: headers, // Send token
            body: JSON.stringify(data)
        });

        hideOverlay("groupOverlay");
        await loadData();
    } catch (err) {
        console.error("Failed to save group:", err);
        alert("Failed to save group.");
    }
}

async function toggleTaskDone(taskId, currentDoneState) {
    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        // Use '/api' routes
        await fetch(`${API_URL}/api/tasks/${taskId}`, {
            method: "PUT",
            headers: headers, // Send token
            body: JSON.stringify({ done: !currentDoneState })
        });
        
        // Optimistic update for speed
        const task = state.tasks.find(t => t.id === taskId);
        if (task) task.done = !currentDoneState;
        renderTasks();
        
        await loadData(); // Sync with server
    } catch (err) {
        console.error("Failed to update task state:", err);
    }
}

async function deleteTask(taskId) {
    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        // Use '/api' routes
        await fetch(`${API_URL}/api/tasks/${taskId}`, { 
            method: "DELETE",
            headers: headers // Send token
        });
        await loadData();
    } catch (err) {
        console.error("Failed to delete task:", err);
        alert("Failed to delete task.");
    }
}

async function deleteGroup() {
    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        // Use '/api' routes
        await fetch(`${API_URL}/api/groups/${state.editingGroupId}`, { 
            method: "DELETE",
            headers: headers // Send token
        });
        
        hideOverlay("groupOverlay");
        state.selectedGroupId = "all";
        await loadData();
    } catch (err) {
        console.error("Failed to delete group:", err);
        alert("Failed to delete group.");
    }
}

async function clearCompletedTasks() {
    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        // Use '/api' routes
        const res = await fetch(`${API_URL}/api/tasks/completed`, { 
            method: "DELETE",
            headers: headers // Send token
        });
        const data = await res.json();
        alert(data.message);
        await loadData();
    } catch (err) {
        console.error("Failed to clear completed tasks:", err);
    }
}

// --- EVENT LISTENERS ---

// Task Modal Buttons
document.getElementById("btnAddTask").addEventListener("click", () => openTaskModal());
document.getElementById("cancelTaskBtn").addEventListener("click", () => hideOverlay("taskOverlay"));
document.getElementById("saveTaskBtn").addEventListener("click", saveTask);

// Group Modal Buttons
document.getElementById("btnAddGroup").addEventListener("click", () => openGroupModal());
document.getElementById("cancelGroupBtn").addEventListener("click", () => hideOverlay("groupOverlay"));
document.getElementById("saveGroupBtn").addEventListener("click", saveGroup);
document.getElementById("deleteGroupBtn").addEventListener("click", () => confirmDeleteGroup(state.editingGroupId));

// Sidebar Navigation
document.getElementById("btnAllTasks").addEventListener("click", () => selectGroup(null));
document.querySelector(".profile-btn").addEventListener("click", () => {
Â  Â  window.location.href = "accountProfile.html";
});
clearCompletedBtn.addEventListener("click", clearCompletedTasks);

// Delete Confirmation Overlay
document.getElementById("confirmNo").addEventListener("click", () => hideOverlay("confirmOverlay"));

let deleteCallback = null;
function showConfirm(title, message, callback) {
Â  Â  document.getElementById("confirmTitle").textContent = title;
Â  Â  document.getElementById("confirmMessage").textContent = message;
Â  Â  deleteCallback = callback;
Â  Â  showOverlay("confirmOverlay");
}
document.getElementById("confirmYes").addEventListener("click", () => {
Â  Â  if (deleteCallback) deleteCallback();
Â  Â  hideOverlay("confirmOverlay");
});

function confirmDeleteTask(taskId, taskName) {
Â  Â  showConfirm(
Â  Â  Â  Â  "Delete Task", 
Â  Â  Â  Â  `Are you sure you want to delete the task: "${taskName}"?`, 
Â  Â  Â  Â  () => deleteTask(taskId)
Â  Â  );
}

function confirmDeleteGroup(groupId) {
    // Use 'g.id'
Â  Â  const group = state.groups.find(g => g.id === groupId);
Â  Â  if (!group) return;
Â  Â  showConfirm(
Â  Â  Â  Â  "Delete Group", 
Â  Â  Â  Â  `Are you sure you want to delete the group "${group.name}"? All associated tasks will also be deleted.`,
Â  Â  Â  Â  deleteGroup
Â  Â  );
}

// --- INITIALIZATION ---
loadUser(); // Start the app

</script>
</body>
</html>
